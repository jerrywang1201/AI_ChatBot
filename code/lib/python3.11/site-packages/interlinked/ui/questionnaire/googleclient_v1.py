import pathlib
from typing import Any, Optional
from fastapi import HTTPException

from interlinked.ui.schemas import Questionnaire, QuestionnaireResponse


def get_response(questionnaire: Questionnaire) -> QuestionnaireResponse:
    """
    Returns questionnaire response for Google AI
    """
    
    next_page: Optional[str] = None
    back_page: Optional[str] = None
    
    error_message: Optional[str] = None
    eligibility: Optional[dict[str, Any]] = None
    
    # determine the next step and previous step based on the current page and form data
    if questionnaire.current_page is None:
        next_page = 'is_transient'
    
    elif questionnaire.current_page == 'is_transient':
        next_page = 'pii'
        back_page = None
    
    elif questionnaire.current_page == 'pii':

        if questionnaire.questionnaire['pii'] in {True, 'true'}:
            next_page = 'no_pii'
        else:
            next_page = 'tiers'
            
        back_page = 'is_transient'
    
    elif questionnaire.current_page == 'no_pii':
        next_page = None  # terminal page
        back_page = 'pii'
    
    elif questionnaire.current_page == 'tiers':
        next_page = 'use_case'
        back_page = 'pii'
    
    elif questionnaire.current_page == 'use_case':
        next_page = 'review'
        back_page = 'tiers'
    
    elif questionnaire.current_page == 'review':
        next_page = 'coding_agreement'
        back_page = 'use_case'
    
    elif questionnaire.current_page == 'coding_agreement':
        next_page = None  # Final step
        back_page = 'review'
    
    else:
        raise HTTPException(status_code=400, detail='Invalid current_page')
    
    questionnaire_steps: dict[str, dict] = {
        'is_transient': {
            'step': 'is_transient',
            'type': 'tabs',
            'subtitle': 'Choose whether you\'d like latest capabilities and AI models with strict rate-limits, or high rate-limits with standard capabilities.',
            'elements': {
                'question': 'How would you like to use Google AI?',
            },
            'options': [
                {
                    'key': 'false', 
                    'label': 'API Keys', 
                    'description': 'Latest capabilities.\nStrict limits.'
                },
                {
                    'key': 'true', 
                    'label': 'Floodgate', 
                    'description': 'Standard capabilities.\nHigh limits.'
                },
            ],
        },
        
        'pii': {
            'step': 'pii',
            'type': 'tabs',
            'subtitle': '[Personal Data](https://infosec.apple.com/apply-security-requirements/governance-resources/personal-data-types) or [Privacy Sensitive Data](https://cloudtech.apple.com/documentation/getting-started/privacy-sensitive-data-types) of any type cannot be used. Including, but not limited to, names, addresses, identifiers, Slack messages, sysdiagnoses, health data, whether aggregated or de-identified.',
            'elements': {
                'question': 'Will you be using Personal or Privacy Sensitive Data in your prompts?',
            },
            'options': [
                {'key': 'true', 'label': 'Yes', 'description': 'I may include this data.'},
                {'key': 'false', 'label': 'No', 'description': 'I will not use any of this data.'},
            ],
        },
        
        'no_pii': {
            'step': 'no_pii',
            'type': 'information',
            'elements': {
                'question': 'Personal Data in Google AI.',
                'description': 'Google AI cannot be used with Personally Identifiable Information (PII) or Privacy Sensitive Data.',
            },
        },
        
        'tiers': {
            'step': 'tiers',
            'type': 'confirmation',
            'elements': {
                'question': 'Tier 0-1 Data',
                'description': 'Please confirm that you will **not** input any data elements in [Information Security Classification](https://infosec.apple.com/apply-security-requirements/governance-resources/data-classification-tiers) Tier 0 or 1 in your prompts.',
                'additional_info': 'If you have questions, we\'re here to help at [#help-interlinked](https://slack.com/app_redirect?channel=help-interlinked).',
            },
        },
        
        'use_case': {
            'step': 'use_case',
            'type': 'textarea',
            'elements': {
                'question': 'Briefly describe your use case.',
                'description': 'Describe how you plan on using Google AI.',
                'placeholder': 'e.g. I am prototyping an internal tool for classifying Radars',
            },
        },
        
        'review': {
            'step': 'review',
            'type': 'review',
            'elements': {
                'statements': [
                    {
                        'id': 'no_pii',
                        'title': 'No Personal Data or Privacy Sensitive Data',
                        'description': 'I will not include any [Personal Data](https://infosec.apple.com/apply-security-requirements/governance-resources/personal-data-types) or [Privacy Sensitive Data](https://cloudtech.apple.com/documentation/getting-started/privacy-sensitive-data-types) in my prompts, including but not limited to names, addresses, identifiers, Slack messages, sysdiagnoses, health data, whether aggregated or de-identified.',
                    },
                    {
                        'id': 'rate_limits',
                        'title': 'Rate limits',
                        'description': 'Visit "Google AI" in [our documentation](/documentation) to learn about rate-limits.',
                    },
                    {
                        'id': 'black_ultra',
                        'title': 'Black/Ultra Data',
                        'description': 'Use of internal and Black/Ultra data **is** permitted. This does not include Tier 0-1, which are different data classifications.',
                    },
                ],
            },
        },
        
        'coding_agreement': {
            'step': 'coding_agreement',
            'type': 'confirmation',
            'elements': {
                'question': 'Third Party Model Generative Coding Agreement',
                'description': None,
            },
        },
    }
    
    # get the data for the next step
    step_data: dict[str, Any] = questionnaire_steps.get(next_page)
    
    # if this is the final confirmation, load the coding agreement
    if next_page == 'coding_agreement':

        BASE_PATH: str = pathlib.Path(__file__).resolve().parent.parent
        STATIC_PATH: str = pathlib.Path(f'{BASE_PATH}/static')
        
        try:
            with open(f'{STATIC_PATH}/third_party_coding_agreement.md', 'r') as file:
                step_data['elements']['description'] = file.read()
        except FileNotFoundError:
            step_data['elements']['description'] = 'Coding agreement content not found.'
    
    # handle special cases for Floodgate logging notice
    if next_page == 'is_transient':

        is_transient = questionnaire.questionnaire.get('is_transient', False)
        if is_transient:
            step_data['elements']['additional_info'] = 'In Floodgate, all messages sent and received from Google AI will be logged for security and legal purposes.'
    
    # handle dynamic description for Black/Ultra data based on transient mode
    if next_page == 'review':

        is_transient = questionnaire.questionnaire.get('is_transient', False)
        black_ultra_statement = next(
            (stmt for stmt in step_data['elements']['statements'] if stmt['id'] == 'black_ultra'), 
            None
        )
        if black_ultra_statement:
            if is_transient:
                black_ultra_statement['description'] = 'Use of internal and Black/Ultra data **is** permitted. This does not include Tier 0-1, which are different data classifications.'
            else:
                black_ultra_statement['description'] = 'Use of internal and Black/Ultra data **is** permitted. The API does not store, cache, log contents of prompts, or used to train models.'
    
    if error_message:
        step_data['elements']['description'] = error_message
    
    # terminal pages should not have next steps
    if next_page in {'no_pii', 'coding_agreement'}:
        next_page = None
        back_page = None
    
    step_data['back_page'] = back_page
    step_data['has_next_step'] = next_page is not None
    
    return QuestionnaireResponse(**step_data)
