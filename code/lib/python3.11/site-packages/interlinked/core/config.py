import os
import logging

logger = logging.getLogger(__name__)


class Config:
	""" Customizable """

	# IdMS (required in production)
	IDMS_APP_ID: int = os.getenv('INTERLINKED_IDMS_APP_ID', 901049)
	IDMS_APP_PASSWORD: str = os.getenv('INTERLINKED_IDMS_APP_PASSWORD')
	IDMS_APP_OIDC_CLIENT_ID: str = os.getenv('INTERLINKED_IDMS_APP_OIDC_CLIENT_ID', '1fxaplubbq7nvgxz9mjauyn1wu41nx')
	IDMS_APP_OIDC_CLIENT_SECRET: str = os.getenv('INTERLINKED_IDMS_APP_OIDC_CLIENT_SECRET')
	DSID: str = os.getenv('INTERLINKED_DSID', 2319733540)

	# radar (optional. required in production, if using radar)
	RADAR_IDMS_APP_CONTEXT: str = os.getenv('INTERLINKED_RADAR_IDMS_APP_CONTEXT')

	# ajax (optional/unused)
	AJAX_IDMS_APP_CONTEXT: str = os.getenv('INTERLINKED_AJAX_IDMS_APP_CONTEXT', 'string')

	# Quip (optional. can be generated from quip-apple.com/dev/token)
	QUIP_ACCESS_TOKEN: str = os.getenv('INTERLINKED_QUIP_ACCESS_TOKEN')

	# Slack (optional)
	# e.g. `xapp-…`
	SLACK_APP_TOKEN_DEV: str = os.getenv('INTERLINKED_SLACK_APP_TOKEN_DEV')

	# e.g. `xoxb-…`
	SLACK_BOT_TOKEN_DEV: str = os.getenv('INTERLINKED_SLACK_BOT_TOKEN_DEV')

	SLACK_APP_TOKEN_PRODUCTION: str = os.getenv('INTERLINKED_SLACK_APP_TOKEN')
	SLACK_BOT_TOKEN_PRODUCTION: str = os.getenv('INTERLINKED_SLACK_BOT_TOKEN')

	SLACK_APP_TOKEN: str = SLACK_APP_TOKEN_DEV or SLACK_APP_TOKEN_PRODUCTION
	SLACK_BOT_TOKEN: str = SLACK_BOT_TOKEN_DEV or SLACK_BOT_TOKEN_PRODUCTION
	SLACK_WEBHOOK_URL: str = os.getenv('INTERLINKED_SLACK_WEBHOOK_URL')

	# AI backend (optional)
	AI_CLIENT_NAME: str = os.getenv('INTERLINKED_AI_CLIENT_NAME', 'ajaxclient')
	AI_MODEL_NAME: str = os.getenv('INTERLINKED_AI_MODEL_NAME')
	AI_EMBEDDING_MODEL_NAME: str = os.getenv('INTERLINKED_AI_EMBEDDING_MODEL_NAME')

	# Anthropic (optional)
	ANTHROPIC_API_KEY: str = os.getenv('INTERLINKED_ANTHROPIC_API_KEY')

	# Ollama (optional)
	OLLAMA_BASE_URL: str = os.getenv('INTERLINKED_OLLAMA_BASE_URL')

	# OpenAI (optional)
	OPENAI_API_KEY: str = os.getenv('INTERLINKED_OPENAI_API_KEY')

	# Google AI (optional)
	GOOGLEAI_API_KEY: str = os.getenv('INTERLINKED_GOOGLEAI_API_KEY')
	GOOGLEAI_PROJECT_ID: str = os.getenv('INTERLINKED_GOOGLEAI_PROJECT_ID')
	GOOGLEAI_LOCATION: str = os.getenv('INTERLINKED_GOOGLEAI_LOCATION')
	APPLECONNECT_TOTP_SECRET: str = os.getenv('INTERLINKED_TOTP_SECRET')
	APPLECONNECT_DEVICE_ID: int = os.getenv('INTERLINKED_DEVICE_ID')

	# Ollama (optional)
	OLLAMA_BASE_URL: str = os.getenv('INTERLINKED_OLLAMA_BASE_URL')

	if not OLLAMA_BASE_URL or OLLAMA_BASE_URL == 'None':
		OLLAMA_BASE_URL = 'http://localhost:11434'

	# MLX (optional)
	MLX_BASE_URL: str = os.getenv('INTERLINKED_MLX_BASE_URL', 'http://localhost:8080')

	# Qdrant (optional)
	QDRANT_PATH: str = os.getenv('INTERLINKED_QDRANT_PATH')

	# ElasticSearch (optional)
	ELASTICSEARCH_USERNAME: str = os.getenv('INTERLINKED_ELASTICSEARCH_USERNAME', 'elastic')
	ELASTICSEARCH_PASSWORD: str = os.getenv('INTERLINKED_ELASTICSEARCH_PASSWORD', '')
	ELASTICSEARCH_CLOUD_ID: str = os.getenv('INTERLINKED_ELASTICSEARCH_CLOUD_ID')  # if cloud is used instead of host
	ELASTICSEARCH_HOSTNAME: str = os.getenv('INTERLINKED_ELASTICSEARCH_HOSTNAME', 'http://localhost:9200/')

	# Endor (optional)
	ENDOR_BASE_URL: str = os.getenv('INTERLINKED_ENDOR_BASE_URL', 'https://api.endor.apple.com')
	ENDOR_OIDC_TOKEN: str = os.getenv('INTERLINKED_ENDOR_OIDC_TOKEN')
	NARRATIVE_CERT_FILE: str = os.getenv('INTERLINKED_NARRATIVE_CERT_FILE')
	NARRATIVE_KEY_FILE: str = os.getenv('INTERLINKED_NARRATIVE_KEY_FILE')

	# OpenDirectory (optional)
	OPENDIRECTORY_PASSWORD: str = os.getenv('INTERLINKED_OPENDIRECTORY_PASSWORD')

	# Object Storage (optional)
	OBJECT_STORAGE_ENDPOINT_URL: str = os.getenv('INTERLINKED_OBJECT_STORAGE_ENDPOINT_URL', 'https://store-031.blobstore.apple.com')
	OBJECT_STORAGE_BUCKET_NAME: str = os.getenv('INTERLINKED_OBJECT_STORAGE_BUCKET_NAME', 'interlinked')
	OBJECT_STORAGE_ACCESS_KEY_ID: str = os.getenv('INTERLINKED_OBJECT_STORAGE_ACCESS_KEY_ID')
	OBJECT_STORAGE_SECRET_ACCESS_KEY: str = os.getenv('INTERLINKED_OBJECT_STORAGE_SECRET_ACCESS_KEY')

	# GitHub (optional)
	GITHUB_TOKEN: int = os.getenv('INTERLINKED_GITHUB_TOKEN')
	GITHUB_APP_ID: int = os.getenv('INTERLINKED_GITHUB_APP_ID', 1560)
	GITHUB_PRIVATE_KEY: str = os.getenv('INTERLINKED_GITHUB_PRIVATE_KEY', '').replace('\\n', '\n')

	# Disclosure Central (optional)
	DISCLOSURE_CENTRAL_USERNAME: str = os.getenv('INTERLINKED_DISCLOSURE_CENTRAL_USERNAME', 'interlinked')
	DISCLOSURE_CENTRAL_PASSWORD: str = os.getenv('INTERLINKED_DISCLOSURE_CENTRAL_PASSWORD')
	DISCLOSURE_CENTRAL_CLIENT_ID: str = os.getenv('INTERLINKED_DISCLOSURE_CENTRAL_CLIENT_ID')
	DISCLOSURE_CENTRAL_CLIENT_SECRET: str = os.getenv('INTERLINKED_DISCLOSURE_CENTRAL_CLIENT_SECRET')

	# Confluence (optional. can be generated from confluence.sd.apple.com/plugins/personalaccesstokens/usertokens.action)
	SD_CONFLUENCE_ACCESS_TOKEN: str = os.getenv('INTERLINKED_SD_CONFLUENCE_ACCESS_TOKEN')

	# local development used for automatic re-authentication (optional)
	APPLECONNECT_USERNAME: str = os.getenv('INTERLINKED_APPLECONNECT_USERNAME_DEV', os.getenv('INTERLINKED_APPLECONNECT_USERNAME'))
	APPLECONNECT_PASSWORD: str = os.getenv('INTERLINKED_APPLECONNECT_PASSWORD_DEV', os.getenv('INTERLINKED_APPLECONNECT_PASSWORD'))

	# Mosaic (optional)
	# visit engweb.apple.com/pypi/apple_mosaic_wrapper
	# and telemetry.g.apple.com/docs/api-auth
	MOSAIC_CLIENT_ID: str = os.getenv('MOSAIC_CLIENT_ID')
	MOSAIC_CLIENT_SECRET: str = os.getenv('MOSAIC_CLIENT_SECRET')

	# FloodGate (optional)
	FLOODGATE_CLIENT_ID: str = os.getenv('INTERLINKED_FLOODGATE_CLIENT_ID', 'hvys3fcwcteqrvw3qzkvtk86viuoqv')
	FLOODGATE_BASE_URL: str = os.getenv('INTERLINKED_FLOODGATE_BASE_URL', 'https://floodgate.g.apple.com/api')

	# Redis in production for automation (optional)
	# run with `docker run -d --name redis -p 6379:6379 redis:8.0-M03-alpine redis-server --requirepass "testing"`
	REDIS_URL: str = os.getenv('INTERLINKED_REDIS_URL', 'redis://localhost:6379/0')

	# StackOverflow (optional. can be generated from https://stackoverflow.apple.com/users/api-applications/11954)
	STACKOVERFLOW_API_KEY: str = os.getenv('INTERLINKED_STACKOVERFLOW_API_KEY')

	# Box (optional)
	BOX_CLIENT_ID: str = os.getenv('INTERLINKED_BOX_CLIENT_ID')
	BOX_CLIENT_SECRET: str = os.getenv('INTERLINKED_BOX_CLIENT_SECRET')
	BOX_DEVELOPER_TOKEN: str = os.getenv('INTERLINKED_BOX_DEVELOPER_TOKEN')

	# Database in production (optional)
	DATABASE_NAME: str = os.getenv('INTERLINKED_POSTGRES_NAME', 'interlinked')
	DATABASE_PASSWORD_PATH: str = os.getenv('INTERLINKED_POSTGRES_PASSWORD_PATH')
	DATABASE_HOSTNAME: str = os.getenv('INTERLINKED_POSTGRES_HOSTNAME', 'localhost')
	DATABASE_ENABLE_MTLS: str = os.getenv('INTERLINKED_POSTGRES_ENABLE_MTLS', False)
	DATABASE_USERNAME: str = os.getenv('INTERLINKED_POSTGRES_USERNAME', 'interlinked')
	DATABASE_PORT: str = os.getenv('INTERLINKED_POSTGRES_CONN_PORT', '5310' if DATABASE_ENABLE_MTLS else '5432')

	if DATABASE_PASSWORD_PATH:
		with open(DATABASE_PASSWORD_PATH, 'r') as f:
			DATABASE_PASSWORD: str = f.read()
	else:
		DATABASE_PASSWORD: str = os.getenv('INTERLINKED_POSTGRES_PASSWORD')

	# Redis in production for automation (optional)
	REDIS_URL: str = os.getenv('INTERLINKED_REDIS_URL', 'redis://localhost:6379/0')

	# local development used for automatic re-authentication (optional)
	APPLECONNECT_USERNAME: str = os.getenv('INTERLINKED_APPLECONNECT_USERNAME_DEV', os.getenv('INTERLINKED_APPLECONNECT_USERNAME'))
	APPLECONNECT_PASSWORD: str = os.getenv('INTERLINKED_APPLECONNECT_PASSWORD_DEV', os.getenv('INTERLINKED_APPLECONNECT_PASSWORD'))

	# LDAP for Calendar
	LDAP_USERNAME: str = os.getenv('INTERLINKED_LDAP_USERNAME', 'interlinked_ai')
	LDAP_PASSWORD: str = os.getenv('INTERLINKED_LDAP_PASSWORD')

	# default proxy when running in production (optional)
	PROXY_URL: str = None

	# skip checking for updates (optional)
	NO_UPDATE: str = os.getenv('INTERLINKED_NO_UPDATE')

	""" UI-specific """

	# whether to use Postgres instead of SQLite (optional)
	USE_POSTGRES: bool = os.getenv('INTERLINKED_USE_POSTGRES', False)

	# whether to authenticate the user with OIDC
	USE_OIDC: bool = os.getenv('INTERLINKED_USE_OIDC', False)

	if isinstance(USE_OIDC, str) and USE_OIDC.lower() == 'false':
		USE_OIDC = False

	# Access manager
	ANTHROPIC_APP_ID: str = os.getenv('INTERLINKED_ANTHROPIC_APP_ID')
	ANTHROPIC_CLIENT_ID: str = os.getenv('INTERLINKED_ANTHROPIC_CLIENT_ID')
	ANTHROPIC_APP_ID_KEY: str = os.getenv('INTERLINKED_ANTHROPIC_APP_ID_KEY')
	ANTHROPIC_CLIENT_SECRET: str = os.getenv('INTERLINKED_ANTHROPIC_CLIENT_SECRET')

	GOOGLEAI_APP_ID: str = os.getenv('INTERLINKED_GOOGLEAI_APP_ID')
	GOOGLEAI_CLIENT_ID: str = os.getenv('INTERLINKED_GOOGLEAI_CLIENT_ID')
	GOOGLEAI_APP_ID_KEY: str = os.getenv('INTERLINKED_GOOGLEAI_APP_ID_KEY')
	GOOGLEAI_CLIENT_SECRET: str = os.getenv('INTERLINKED_GOOGLEAI_CLIENT_SECRET')

	""" Static """

	current_config: str = None
	is_development: bool = True


class ProductionConfig(Config):

	DATABASE_HOSTNAME: str = os.getenv('INTERLINKED_POSTGRES_HOSTNAME', 'interlinked-postgres')

	PROXY_URL: str = os.getenv('INTERLINKED_PROXY_URL', 'http://dps.iso.apple.com:443') or None

	USE_POSTGRES: bool = os.getenv('INTERLINKED_USE_POSTGRES', True)

	is_development: bool = False


# set current config
CONFIG_DICT: dict = {'production': ProductionConfig}
Config.current = CONFIG_DICT.get(os.getenv('INTERLINKED_CONFIG'), Config)