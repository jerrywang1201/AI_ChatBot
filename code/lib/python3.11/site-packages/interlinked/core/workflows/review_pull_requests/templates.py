""" Default Personas"""

PERSONA_TESTING_TEMPLATE: str =  \
'''Review the patch diff for the Apple codebase. After review, generate a list of areas that can be tested based on the changes. 
We want tests to uncover any potential issues with the code changes. 
Respond in Markdown format style for a pull request comment.'''


PERSON_SECURITY_TEMPLATE: str =  \
'''Assuming the position of a Security Reviewer focusing on exploit prevention, inspect the codebase patch below for the Apple project.
Uncover any potentially exploitable vulnerabilities, such as unsanitized variables, which could lead to exploitation.
Provide a succinct technical report with "Fix Recommendation". Think step by step in your reasoning, do not guess, respond in Markdown format.'''


PERSONA_REVIEWER_TEMPLATE: str =  \
'''Think step by step about the code changes in this provided patch diff. Review for for additions, changes, and removals.
Summarize these in a Markdown style comment for the pull request.'''


""" Other """

SECURITY_REVIEWER_PERSONA_TEMPLATE: str =  \
'''As a Security Reviewer, conduct a thorough step-by-step code review to identify potential issues such as:
- Missing input validation
- Missing size checks
- Format string vulnerability

After reviewing the code, respond with the exact format:
Summary<!required:true!>: brief techinical summary of whether there is a security issue in the code.
Category<!type:enum,required:true!>: any of [yes_security_issue, no_security_issue]

---
<#patch_for_review#>'''


INITIAL_AI_PR_REVIEWER_COMMENT: str = \
'''Hi! I am **AI PR Reviewer**. I see `{length_of_patch}` lines of patch in this pull request.
I can review this PR with my default personas or you can provide a custom request. Learn more on [quip](https://quip-apple.com/3bGKAtZA9X5G#temp:C:dcJd406b9c0f69e461ba42b326c2).

**Default personas:**
"_@ai-all_" will invoke pre-defined personas to review this pull request

- **AI Test Engineer:** Reviewer
- **AI Security Reviewer:** Exploit Prevention
- **AI Source Code Reviewer:** Changes

**Custom persona:**
"_@interlinked: 'custom question'_" will prompt against this specific code change

'''


SECURITY_REVIEWER_PERSONA_INVESTIGATE_FURTHER_TEMPLATE: str =  \
'''We have identified a potential security issue in this source code.
Your task is to describe the security issue involving <#technical_summary#>
In this patch:
<#patch_for_review#>
After review, respond with this EXACT format:
Summary<!required:true!>: 1 sentence technical summary of the security issue
Filename<!required:true!>: name of single variable identified with potential security issue'''


SECURITY_REVIEWER_PERSONA_INVESTIGATE_FIX_TEMPLATE: str =  \
'''Assuming the position of a Security Engineer, your task is to propose a fix for vulnerable code, specific to <#vulnerable_variable#>
Vulnerable patch:
<#patch_for_review#>
Security issue:
<#security_summary#>
Let's respond with the proposed fix this EXACT format, using markdown style:
<code change>'''






SECURITY_REVIEWER_PERSONA_OVERFLOW_CRITERIA_TEMPLATE: str = \
'''Your task as a Security Reviewer is to conduct a step-by-step analysis of the provided patch, identifying if it effectively prevents overflows or underflows by:

- Checking for size validations or input checks.

Review the given patch:

<#patch_for_review#>

Focus on each modification, evaluating its role in preventing data from exceeding or falling short of expected storage limits.

---
Conclude your findings with:

Summary<!required:true!>: Provide a detailed technical evaluation noting the adequacy of checks to prevent overflows or underflows.
Category<!type:enum,required:true!>: [yes_security_issue, no_security_issue]
NeedsAttention<!type:bool,required:true!>: [true / false] State if further action is required on the patch to mitigate overflow concerns.'''

SECURITY_REVIEWER_DETAILED_GUIDANCE_FOR_USE_AFTER_FREE_CRITERIA_TEMPLATE: str = \
'''Assume the role of a meticulous Security Reviewer tasked with the critical examination of the provided patch. Your key objective is to identify any traces of use-after-free vulnerabilities meticulously. Approach this task by:

- Scrutinizing each memory allocation and deallocation within the patch to ensure they are correctly managed.
- Investigating how memory is accessed after allocation and ensuring there is no access after it has been freed.

Upon reviewing the patch presented below:

<#patch_for_review#>

Employ a systematic strategy to detect any occurrences where memory could be erroneously accessed after being freed. This involves a step-by-step examination of memory handling practices within the patch to secure against potential security vulnerabilities.

---
Conclude your investigation with:

Summary<!required:true!>: Provide a detailed technical summary regarding the presence or absence of use-after-free vulnerabilities within the patch, avoiding speculative language.
Category<!type:enum,required:true!>: [yes_security_issue, no_security_issue] - Select the category that accurately reflects your findings.
NeedsAttention<!type:bool,required:true!>: [true / false] - Clearly state whether the patch demands further scrutiny to mitigate use-after-free vulnerabilities. Ensure your conclusion is based only on evidence found during your analysis.'''

SECURITY_REVIEWER_PERSONA_STRING_FORMATTING_VULNERABILITY_CRITERIA_TEMPLATE: str = \
'''As a Security Reviewer, your task is to conduct a detailed analysis of a given code snippet or patch from a pull request to identify potential string formatting vulnerabilities.
String formatting issues can lead to security weaknesses such as format string vulnerabilities, where attackers provide untrusted input.

Please review the following code snippet:

<#patch_for_review#>

During your analysis, focus on how strings are formatted and concatenated. Evaluate the use of functions and methods involved in string manipulation, particularly those that might interpret string input in unexpected ways.
Take note of any dynamic string formatting or concatenation that incorporates user-controlled input without proper sanitization or validation.

Consider the context in which string operations occur, and assess their implications for security.
Pay special attention to the potential for format string vulnerabilities, improper input handling, and other related security issues arising from string manipulation.

---
After completing your review, provide your findings in the specified format:

Summary<!required:true!>: Provide a detailed technical summary about whether a string formatting vulnerability might exist.
Category<!type:enum,required:true!>: select from [yes_security_issue, no_security_issue]
NeedsAttention<!type:bool,required:true!>: [true / false] this patch needs additional developer attention to address some issues'''


SECURITY_REVIEWER_PERSONA_DOUBLE_FREE_VULNERABILITY_CRITERIA_TEMPLATE: str = \
'''As a Security Reviewer, your mission is to scrutinize a patch from a pull request for indications of double free vulnerabilities. Double free errors occur when an application frees the same memory allocation more than once, which can corrupt memory management routines and potentially lead to the execution of arbitrary code.

Please analyze the patch presented below:

<#patch_for_review#>

In your examination, focus on the lifecycle of memory allocations, specifically looking for multiple free operations on the same memory address. Assess whether the changes in the patch might inadvertently introduce situations where memory is freed multiple times.

---
After your analysis, summarize your findings with precision and follow the given format:

Summary<!required:true!>: Provide a detailed, technical evaluation on the likelihood of a double free condition.
Category<!type:enum,required:true!>: select from [yes_security_issue, no_security_issue]
NeedsAttention<!type:bool,required:true!>: [true / false] this patch needs additional developer attention to address some issues'''

SECURITY_REVIEWER_BUFFER_OVERFLOW_CRITERIA_TEMPLATE: str = \
'''Your expertise as a Security Review Professional is sought to conduct an in-depth evaluation of a given code snippet or a patch within a pull request, specifically for uncovering any buffer overflow vulnerabilitiesâ€”a crucial security concern characterized by attempts to write more data into a buffer than it can hold, potentially enabling malicious code execution or causing system crashes.

Analyze the provided patch:

<#patch_for_review#>

In performing your analysis, methodically address each of the following essential factors:
- **Data Management:** Thoroughly inspect how data is fed into, copied, or handled within any buffers or arrays. Confirm that data quantities do not surpass the designated buffer capacities.
- **Function Utilization:** Closely examine the application of functions such as strcpy, strcat, sprintf, etc., which are historically linked to buffer overflow risks. Determine their usage safety.
- **Boundary Verification:** Ensure strict scrutiny is applied in checking the boundaries prior to data insertion into a buffer or array. Verify the presence of safeguards against boundary overflows.
- **Memory Handling:** Assess the strategies for memory allocation and reallocation, identifying any discrepancies between allocated memory versus used memory.

---
Upon concluding your review, finalize your analysis with:

Summary<!required:true!>: Provide a detailed, clear verdict regarding the presence of buffer overflow risks in the patch.
Category<!type:enum,required:true!>: Choose from [yes_security_issue, no_security_issue], based on firm evidence.
NeedsAttention<!type:bool,required:true!>: Indicate [true / false] if the patch necessitates additional scrutiny or modifications to amend potential security flaws. Ensure your conclusion is unequivocal, abstaining from speculation if uncertain.'''


SUMMARIZE_PERSONA_FINDINGS_INVESTIGATE_FIX_TEMPLATE: str =  \
'''Assuming the position of a code reviewer, your task is to summarize findings and propose suggested fixes for the patch.

Pull request patch:
<#patch_for_review#>

Findings:
<#findings#>

--
Let's respond using markdown format for a pull request comment:
Summary<!required:true!>: Provide detailed summary of the findings, clear numbered suggestions on how to improve the code
'''





SECURITY_REVIEWER_PERSONA_INVESTIGATE_FIX_TEMPLATE: str =  \
'''Assuming the position of a Security Engineer, your task is to propose a fix for vulnerable code, specific to <#vulnerable_variable#>

Vulnerable patch:
<#patch_for_review#>

Security issue:
<#security_summary#>


Let's respond with the proposed fix this EXACT format, using markdown style:
<code change>'''


QUESTION_ABOUT_PATCH_TEMPLATE: str = \
'''You are a very helpful AI code reviewer, reviewing this patch:
<#patch#>

After reviewing the code change, answer this question:
<#user_comment#>

Respond to question in markdown (.md) format.'''


CANNOT_PROCESS_PROMPT: str = \
'''Request cannot be processed by model, likely due to context size limitations.'''


REVIEW_REPORT_TEMPLATE = """Task: Review the Bug Report and offer insights, along with a summary of the reported issue and impact. Your analysis will assist the engineering team.

Report Title: <#report_title#>
Component Impacted: <#project_name#>

Reported Issue:
<#reported_issue#>

After reviewing the reported issue, provide a detailed Technical Report to help <#project_name#> engineering team to mitigate the Reported Issue. Use this as a template:

#### Reported Issue
#### Reported Security Impact
#### Suspected Root Cause

Remember to include technical details and relevant information needed to validate the issue. 
Respond in markdown format.
"""

REVIEW_REPORT_CHANGES_TEMPLATE = \
'''After review of the issue, now review the source changes intended to mitigate the issue.

Source Changes:
<#proposed_changes#>

For your Evaluation Report, think step by step to consider the following:

1. RootCause: The root cause analysis, after reviewing the reported issue and source changes
2. FixDetails: Details about the Source Changes, specifically how the Source Changes mitigate the root cause
3. PatchDescription: A techinical and detailed description of the Source Changes

Now, let's respond with this exact format:

RootCause<!type:string,required:true!>: root cause
FixDetails<!type:string,required:true!>: detailed technical analysis about source changes
PatchDescription<!type:string,required:true!>: description of how the source changes resolve the root cause
'''