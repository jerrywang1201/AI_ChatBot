import json
import logging
import unittest
import threading
from radarclient import Component

from interlinked.core.classes import ExternalItem
from interlinked.core.clients.customradarclient import RadarClient
from interlinked.core.workflows.screen_radars.workflow import AIScreener

logger = logging.getLogger(__name__)


class TestAIScreener(unittest.TestCase):
    """
    Tests utilities in AIScreener. For benchmarks, see `benchmarks` folder
    """

    def test_component_sorting(self):
        """
        Tests component name and version sorting
        """

        # 1. sort components
        components: list[Component] = [

            Component(name='Safari', version='New Bugs'),
            Component(name='BarcodeSupport', version='iOS'),
            Component(name='Wallet', version='Muirfield'),
            Component(name='Safari', version='Some version'),
            Component(name='Safari', version='Other'),
            Component(name='Safari', version='All'),
            Component(name='Safari', version='New'),
            Component(name='Safari (macOS)', version='New Bugs'),
            Component(name='Safari (macOS)', version='Other Bugs'),
            Component(name='Safari (visionOS)', version='New Bugs'),
        ]

        self.assertIn(AIScreener.sort_components(components=components)[0].version, {'New Bugs', 'All'})
        self.assertIn(AIScreener.sort_components(components=components)[1].version, {'New Bugs', 'All'})

        # sort by platform and New Bugs/All
        self.assertIn('macOS', AIScreener.sort_components(components, platform_name='macOS')[0].name)
        self.assertIn('macOS', AIScreener.sort_components(components, platform_name='visionOS')[3].name)

        # 2. sort components (prioritize first component because it's repeated)
        components: list[Component] = [

            Component(name='BarcodeSupport', version='iOS'),
            Component(name='BarcodeSupport', version='macOS'),
            Component(name='BarcodeSupport', version='iOS'),
            Component(name='BarcodeSupport', version='iOS'),
            Component(name='Wallet', version='Muirfield'),
            Component(name='Wallet', version='Muirfield'),
            Component(name='Safari', version='New Bugs'),
            Component(name='Safari', version='All'),
            Component(name='Safari (macOS)', version='New Bugs'),
        ]

        self.assertEqual(AIScreener.sort_components(components=components)[0].version, 'iOS')
        self.assertEqual(AIScreener.sort_components(components=components)[1].version, 'macOS')

        # sort by platform and New Bugs/All
        self.assertIn('macOS', AIScreener.sort_components(components, platform_name='macOS')[0].version)

        # 2.1 sort components (prioritize first component because it's first)
        components: list[Component] = [

            Component(name='Photos', version='New Bugs'),
            Component(name='Sandbox', version='New Bugs'),
            Component(name='Photos iCloud Backend', version='New Bugs'),
            Component(name='Safari', version='New Bugs'),
        ]

        components = AIScreener.sort_components(components=components)
        self.assertEqual(components[0].name, 'Photos')
        self.assertEqual(components[0].version, 'New Bugs')

        # 3. sort components with no "New Bugs" in them
        components: list[Component] = [

            Component(name='Reminders', version='Framework'),
            Component(name='Reminders', version='iOS'),
            Component(name='Reminders', version='macOS'),
            Component(name='Reminders', version='watchOS'),
        ]

        self.assertEqual(AIScreener.sort_components(components=components)[0].version, 'iOS')
        self.assertEqual(AIScreener.sort_components(components=components)[1].version, 'macOS')
        self.assertEqual(AIScreener.sort_components(components=components)[-1].version, 'Framework')

        # 4. sort components with no "New Bugs" in them, and names that are longer
        components: list[Component] = [

            Component(name='Quick Look', version='iOS'),
            Component(name='Quick Look', version='macOS'),
            Component(name='Quick Look', version='watchOS'),
            Component(name='Quick Look Office', version='All'),
        ]

        components = AIScreener.sort_components(components, search_term='Quick Look')
        self.assertEqual(components[0].version, 'iOS')
        self.assertEqual(components[1].version, 'macOS')
        self.assertEqual(components[-1].version, 'watchOS')

        components: list[Component] = [

            Component(name='Mail Provider Relations', version='All'),
            Component(name='Mail', version='All'),
            Component(name='Mail', version='iOS'),
        ]

        components = AIScreener.sort_components(components, search_term='Apple Mail')
        self.assertEqual(components[0].name, 'Mail')
        self.assertEqual(components[0].version, 'All')
        self.assertEqual(components[1].version, 'iOS')

        components: list[Component] = [

            Component(name='Apple Pay', version='New Bugs'),
            Component(name='Siri Payments', version='All'),
            Component(name='Apple Pay', version='iOS'),
        ]

        components = AIScreener.sort_components(components, search_term='Apple Pay')
        self.assertEqual(components[0].version, 'New Bugs')
        self.assertEqual(components[1].version, 'iOS')

    def test_get_is_search_term_valid(self):
        """
        Ensures that search terms are validated correctly
        """

        self.assertTrue(AIScreener.get_is_search_term_valid(search_term='Safari'))
        self.assertTrue(AIScreener.get_is_search_term_valid(search_term='iOS Configurator'))
        self.assertTrue(AIScreener.get_is_search_term_valid(search_term='ANE_ProgramSendCachedRequest'))
        self.assertTrue(AIScreener.get_is_search_term_valid(search_term='ANE_ProgramSendCachedRequest()'))

        self.assertFalse(AIScreener.get_is_search_term_valid(search_term='iOS'))
        self.assertFalse(AIScreener.get_is_search_term_valid(search_term='iOS 17'))
        self.assertFalse(AIScreener.get_is_search_term_valid(search_term='iOS 17 Bug'))
        self.assertFalse(AIScreener.get_is_search_term_valid(search_term='Bug in iOS'))
        self.assertFalse(AIScreener.get_is_search_term_valid(search_term='CVE-123-4567'))

    def test_excluded_components(self):
        """
        Ensures that some components are excluded correctly
        """

        self.assertEqual(AIScreener.get_should_exclude_component(component=Component(name='ManagedClient SRE', version='All'), classification='Security'), True)
        self.assertEqual(AIScreener.get_should_exclude_component(component=Component(name='Device Management', version='Automation'), classification='Security'), True)
        self.assertEqual(AIScreener.get_should_exclude_component(component=Component(id=139001, name='ManagedClient', version='All'), classification='Security'), False)
        self.assertEqual(AIScreener.get_should_exclude_component(component=Component(id=1555824, name='Health Chutney', version='All'), classification='Enhancement'), False)

    def test_summary(self):
        """
        Ensures that the summary comment is updated correctly
        """

        self.assertEqual(AIScreener.get_updated_summary(summary='MacBook Pro\'s Safari app'), 'Safari app')
        self.assertEqual(AIScreener.get_updated_summary(summary='the iPhone\'s Camera app'), 'the Camera app')
        self.assertEqual(AIScreener.get_updated_summary(summary='the iPhone on the table'), 'the iPhone on the table')

    def test_get_is_daemon_or_tool(self):
        """
        Ensures that the daemon/tool names are detected correctly
        """

        self.assertTrue(AIScreener.get_is_daemon_or_tool(name='installd'))
        self.assertTrue(AIScreener.get_is_daemon_or_tool(name='ldmtool'))

        self.assertFalse(AIScreener.get_is_daemon_or_tool(name='Computer'))
        self.assertFalse(AIScreener.get_is_daemon_or_tool(name='Surfboard'))
        self.assertFalse(AIScreener.get_is_daemon_or_tool(name='iCloud diagnostics tool'))


if __name__ == '__main__':
    unittest.main()