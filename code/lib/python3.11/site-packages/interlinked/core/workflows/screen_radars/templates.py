class Templates:

	PLATFORM_NAMES: list[str] = ['iOS', 'iPadOS', 'macOS', 'tvOS', 'watchOS', 'visionOS', 'N301', 'for Windows', 'Windows', 'Android']
	DEVICE_NAMES: set[str] = {'iPhone', 'iPad', 'Apple TV', 'Apple Watch', 'Watch', 'Vision Pro', 'Mac', 'MacBook',
							  'MacBook Pro', 'MacBook Air', 'Mac Mini', 'Mac Studio', 'iMac', 'AirPods'}

	@classmethod
	def get_invalid_enum_options(cls) -> set[str]:

		if not hasattr(cls, '_INVALID_ENUM_OPTIONS'):

			# TODO: consider adding verbs that end with `*ing` (e.g. `Copying`, rdar://111922796)
			cls._INVALID_ENUM_OPTIONS = {'Google Chrome*', 'Microsoft *', 'html', 'GWP-ASan',
										 'iCloud', '*Vulnerability*', '*Bug*', '*Radar*', 'Documentation', 'Authorization',
										 'Authentication', 'Apple', 'escape', 'device', 'App', 'glitch', 'buffer overflow',
										 'overflow', 'sandboxed process', 'sandboxed app'}

			cls._INVALID_ENUM_OPTIONS = cls._INVALID_ENUM_OPTIONS.union({f'{device_name}*' for device_name in cls.DEVICE_NAMES})
			cls._INVALID_ENUM_OPTIONS = cls._INVALID_ENUM_OPTIONS.union({f'{platform_name}*' for platform_name in cls.PLATFORM_NAMES})

			# add macOS marketing release names (e.g. `Ventura`, `Sonoma`)
			# releases: list[Release] = Release.select(Release.train, Release.marketing_name).join(Platform).where(Platform.name == 'macOS', Release.marketing_name.startswith('macOS '), ~(Release.marketing_name.contains('Update')), ~(Release.marketing_name.contains('(')))
			# release_marketing_names: set[str] = {release.marketing_name.strip().removeprefix('macOS ').rsplit(' ', 1)[0] for release in releases}
			# cls._INVALID_ENUM_OPTIONS = cls._INVALID_ENUM_OPTIONS.union(release_marketing_names)
			# cls._INVALID_ENUM_OPTIONS = cls._INVALID_ENUM_OPTIONS.union({release.train for release in releases if release.train})
			# cls._INVALID_ENUM_OPTIONS = cls._INVALID_ENUM_OPTIONS.union({f'Guardian{release.train}' for release in releases if release.train})

		return cls._INVALID_ENUM_OPTIONS


INITIAL_TEMPLATE: str =  \
f'''You are a senior engineer at Apple. What is the <#display_classification#> being reported below about? Take a deep breath and think step by step. Focus on where the <#display_classification#> is.

<#display_classification#> description:
<#title#>
<#description#>'''


COMPONENT_TEMPLATE: str =  \
f'''You are a software engineering screener. Your task is to help me find the right engineering team to send the <#display_classification#> report below to. This means you need to identify and extract the name of the vulnerable component.
Vulnerable component is where the bug is happening. It can be the app name, daemon, service, technology, project, or function. For example, if "WebKitProcessor" is mentioned, the vulnerable component would be the commonly known name, which is "WebKit".

Focus on the vulnerable component (app name, service, project, daemon, kext, framework, etc). If it's a feature, think to yourself, what Apple app/process is the feature in?

Example components: XNU, Photos, Gatekeeper, Safari, WebKit, JavaScriptCore, Lock screen
Example invalid components: macOS Ventura, iOS, iPhone

Please respond to me with the EXACT format:
Thought<!type:string!>: Take a deep breath and work on this task step-by-step. Vulnerable component names are typically ONE word only. Pick the most technical term mentioned in the report
Vulnerable component<!type:enum,required:true,alternative_name:component_name,invalid_enum_options:{"|".join(Templates.get_invalid_enum_options())},min_length:3,max_segments:4!>: Name of vulnerable product, service, project, or function mentioned in the report. It must be a component mentioned in the report. Same line. Just the name.

---
<#title#>
<#description#>'''


PICK_SUBCOMPONENT_TEMPLATE: str =  \
f'''Which of the following components best match this <#display_classification#> report?

<#component_descriptions#>
---

Let's respond with the EXACT format:
Component name<!type:enum,required:true!>: must be just the name of one of the components listed above
Thought<!type:string,required:true!>: Your detailed thoughts on which component best matches'''


MINI_HELPER_TEMPLATE: str =  \
f'''Given the description below, respond with the EXACT format:
Thought: think about about the product, service, or function mentioned in the description
Affected product<!type:enum,required:true,alternative_name:component_name,invalid_enum_options:{"|".join(Templates.get_invalid_enum_options())},min_length:3,max_segments:3!>: the name of vulnerable product, service, project, or function mentioned in the report, not the <#display_classification#> type. One word

Example affected products: XNU, Photos, Gatekeeper, Safari, WebKit, JavaScriptCore, Lock screen
Example invalid affected products: macOS Ventura, iOS, iPhone

---
Description:
<#title#>
<#description#>'''


EXTRACTOR_TEMPLATE: str =  \
f'''Extract the product name from the description below. Respond with the EXACT format:
Thought: think about about the product, service, or function mentioned in the description
Product name<!type:enum,required:true,alternative_name:component_name,invalid_enum_options:{"|".join(Templates.get_invalid_enum_options())},min_length:3,max_segments:3!>: the name of product, service, project, or function, not the <#display_classification#> type. One word. Write it exact as it’s written in the description

Example product names: XNU, Photos, Gatekeeper, Safari, WebKit, JavaScriptCore, Lock screen

Notice how product names are usually ONE word only

---
<#component_name#>'''


VERIFY_COMPONENT_TEMPLATE: str =  \
f'''Is "<#component_name#>" the correct vulnerable technical component where the <#display_classification#> is?

Components are typically one to two words maximum, where the <#display_classification#> occurs and what is being used to trigger it. They can be the name of a product, service, project, or function mentioned in the report.
Example invalid components: operating system names (e.g. macOS Ventura, iOS 16)

Respond to me with the exact following format:
Fits component<!type:bool!>: Yes/No
Correct component<!type:enum,required:true,alternative_name:component_name!>: if your answer to "Fits component" above was No, write the component you think is correct. Respond on the same line. Write ONLY the name'''


# pick component from knowledge
COMPONENT_KNOWLEDGE_TEMPLATE: str =  \
f'''You are a software engineering screener. Given the knowledge base below, your task is find the best component name to send this report to.
Component names are typically formatted like this: "… | …"

Let's respond with the EXACT format:
Summary<!type:string!>: Take a deep breath and work on this task step-by-step.
Component name<!type:string,required:false!>: the name from the knowledge base below. if none match, this should be "None"

---
Knowledge base:
<#knowledges#>

---
Report:
<#title#>
<#description#>'''


# picks one of two components (TODO: rdar://108849081)
COMPONENT_PICKER_TEMPLATE: str =  \
f'''Read the description below. Which of the terms component names best describes the report?

Respond with the EXACT format:
Best component name<!type:enum,required:true!>: MUST be one of [<#component_names#>]

---
<#title#>
<#description#>'''


# whether the radar is a report of a security vulnerability or not
CLASSIFICATION_EXTERNAL_TEMPLATE: str =  \
f'''Can you classify the report? Here are the available classifications:
- Security: Potential security or privacy vulnerability, or software exposes user private information
- Other Bug: A problem where a feature is broken or glitching unrelated to security
- Crash/Hang/Data Loss: A problem that causes a machine to panic, an app to crash or hand or loss of data, unrelated to security
- Enhancement: A request for an enhancement to an existing feature

Let's respond with the EXACT format:
Summary<!type:string,required:true!>: one-line brief casual summary. For example, "Bug in xyz that allows arbitrary file read"
Classification<!type:enum,required:true!>: MUST be EXACTLY one of [security, other_bug, crash_hang_data_loss, enhancement]'''


CLASSIFICATION_SEED_TEMPLATE: str =  \
f'''We are a team at Apple. We receive reports from security researchers, developers, and sometimes, non-technical customers.

Your task is to read the report below and determine if if it's an actual <#display_classification#> report or if it's nonsense. A nonsense report is someone thinking they're hacked, scammed, or gibberish

Let's respond with the EXACT format:
Thought<!type:string!>: your thoughts on the report and whether you think it's legitimate or just nonsense
Category<!required:true,type:enum!>: MUST be one of [valid, nonsense]

---
Report:
<#title#>
<#description#>'''


CLASSIFICATION_INTERNAL_TEMPLATE: str =  \
'''We are an engineering team at Apple. We receive bugs and feature requests from other teams at the company.

Your task is to help me summarize and classify the report below.

Let's respond with the EXACT format:
Summary<!type:string,required:true!>: one-line brief casual summary. For example, "Bug in xyz that allows arbitrary file read"
Classification<!type:enum,required:true!>: MUST be EXACTLY one of [security, other_bug, crash_hang_data_loss, ui_usability, enhancement, task]

Description of each classification:
- Security: A problem that mentions or poses a security or privacy vulnerability in products/software.
- Other Bug: A problem where a feature is broken or glitching.
- Crash/Hang/Data Loss: A problem that causes a machine to panic, an app to crash or hand or loss of data.
- UI/Usability: A problem specifying an unexpected user interface issue. Not to be confused with requests for enhancements or new features that are exposed via the user interfaces.
- Enhancement: A request for an enhancement to an existing feature.
- Task: A necessary action that doesn’t match any of the other classification values.

---
Report:
<#title#>
<#description#>'''


# get the affected platform
PLATFORM_NAME_TEMPLATE: str =  \
f'''The report below was sent to our team at Apple. Your task is to help me determine which operating system the report is about. I really need your help.

Think about the report. At the end of your response, respond with the EXACT format:
Affected operating system<!required:true!>: MUST be EXACTLY one of [{", ".join(Templates.PLATFORM_NAMES)}]

---
<#title#>
<#description#>'''


# duplicates: extract relevant terminology
EXTRACT_RELEVANT_TERMINOLOGY_TEMPLATE: str =  \
'''You're a senior data analyst and engineer. We are an engineering team at Apple that is responsible to fixing bugs and building features. Your task is to help me find if the bug report/feature request below is a duplicate of an existing one in our queue by extracting a list of the most relevant terms mentioned.

Please respond exactly with a numbered list of the best single words that can be used to describe the report/request. Do not describe them, just list them.

Focus on the following:
- Feature names, functions, and process names
- If it's a crash, focus on where it crashed and extract relevant functions, variables, processes, etc
- Best words that describe the issue reported or enhancement requested. Be very brief or split it into multiple lines. Don't rewrite them

Exclude version numbers, beta versions, and device names. I will then use your response to search the database for duplicates. I depend on your help and really appreciate it.

---
<#title#>
<#description#>'''


# duplicates: verify if the same
VERIFY_DUPLICATE_TEMPLATE: str =  \
'''Is this a duplicate of the <#display_classification#> below? <#conditional_statements#>

Note: It is a duplicate if it's about the same feature, function, issue, etc or is extremely similar. Do not take into consideration irrelevant data/information like timestamps, names, content.
Note: Think about if they could be possibly the same underlying issue.
Important: If one has much less details than the other, ignore the additional details and focus purely on whether they talk about the same <#display_classification#>.

Compare the two and think step by step whether they're both about the same <#display_classification#>. At the end of your response, respond with the EXACT format:
Reasoning<!type:string,required:true!>: your detailed thoughts on whether this is a duplicate
Duplicate<!type:bool,required:true!>: Yes/No

---
<#title#>
<#description#>'''


# check if null-dereference
NULL_DEREFERENCE_TEMPLATE: str =  \
f'''Analyze the report below that was sent to Apple. Respond with the EXACT format:
Is null deref<!required:true!>? Yes/No. Whether this report mentions a null pointer dereference (or null deref)

---
<#title#>
<#description#>'''