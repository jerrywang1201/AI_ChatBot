import re
from bs4 import BeautifulSoup, Tag, NavigableString

from interlinked.core.ai import Section
from interlinked.core.parsers.htmlparser import HTMLParser
from interlinked.core.clients.stackoverflowclient import Article


class StackOverflowParser(HTMLParser):
    """
    Parses StackOverflow articles and converts them to `Section`
    """

    @classmethod
    def get_section_for_html(cls, content: str, article: Article = None) -> Section:
        """
        Parses a given a Confluence document html, then returns a `Section`

        @param content(str): (Optional) The HTML content returned by `StackOverflowClient.get_article(…).html`
        @param article(Article): (Optional) The Article itself returned by `StackOverflowClient.get_article(…)` used to
                                 maintain links
        """

        beautiful_soup: BeautifulSoup = BeautifulSoup(content, 'html.parser')

        if article:

            # add an `id` attr to every header with a direct link to the section
            # e.g. `stackoverflow.apple.com/articles/32439#heading-ci-job-dequeue-or-ci-job-start`
            for tag in beautiful_soup.find_all(['h1', 'h2', 'h3', 'h4', 'h5', 'h6']):
                tag['id'] = f'{article.id}#heading-{tag.text.lower().replace(" ", "-").replace("?", "")}'

        return HTMLParser.get_section_for_html(content=str(beautiful_soup))


if __name__ == '__main__':

    from interlinked.core.clients.stackoverflowclient import StackOverflowClient

    article: Article = StackOverflowClient.shared.get_article(id=32439)
    print(StackOverflowParser.get_section_for_html(content=article.body, article=article).subsections[0].external_id)
