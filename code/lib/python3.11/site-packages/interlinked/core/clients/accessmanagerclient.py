import logging
import requests
from typing import Any
from requests.adapters import HTTPAdapter, Retry

from interlinked.core.config import Config
from interlinked.core.utilities import Utilities
from interlinked.core.singleton import SingletonMeta

logger = logging.getLogger(__name__)

class AccessManagerClient(metaclass=SingletonMeta):
    """
    [Internal]
    """

    ACCESS_REQUEST_URL = 'https://access-request.g.apple.com/cars/access-requests'

    def __init__(self, app_id: str = None):
        """
        Initializes the Access Manager
        """
        self.configure_session()

    def configure_session(self) -> None:
        """
        [Internal]
        Configures the session
        """

        self.session = requests.session()
        retry: Retry = Retry(total=6, backoff_factor=3, status_forcelist=[500, 502, 503, 504, 429])
        http_adapter: HTTPAdapter = HTTPAdapter(max_retries=retry)
        self.session.mount('http://', http_adapter)
        self.session.mount('https://', http_adapter)

    @SingletonMeta.Shared
    def shared(cls) -> 'AccessManagerClient':
        return cls(shared=True)

    def request_access_for_dsid(self, dsid: int, purpose: str, role: str, app_id: str, app_id_key: str,
                                client_id: int, client_secret: str) -> dict[str, Any]:
        """
        [Internal]
        Request access to a system

        @param dsid(int): The DSID of the person to give access to
        @param purpose(str): The purpose of giving access to a system
        @param role(str): e.g. "Interlinked Anthropic Access"
        @param app_id(str): The ID of your app (from IdMS)
        @param app_id_key(str): The ID of your app (from IdMS)
        @param client_id(str): The ID of your app (from IdMS)
        @param client_secret(str): The secret of your app (from IdMS)
        """

        access_token: str = Utilities.get_oidc_access_token(app_id=app_id, app_id_key=app_id_key,
                                                            client_id=client_id, client_secret=client_secret)

        payload: dict[str, Any] = {

            'identity': {'id': f'urn:aiam-rsrc:person:{dsid}'},
            'grant': [

                {
                    'attributes': [
                        {
                            'id': 'urn:aiam-attr:request:purpose',
                            'values': [purpose]
                        }
                    ],
                    'target': f'urn:aiam-rsrc:system:{app_id}'
                },
                {
                    'attributes': [
                        {
                            'id': 'urn:aiam-attr:request:purpose',
                            'values': [purpose]
                        }
                    ],
                    'target': f'urn:aiam-rsrc:system:{app_id}',
                    'role': f'urn:aiam-rsrc:system:{app_id}:role:{role}'
                }
            ]

        }

        headers: dict[str, str] = {

            'content-type': 'application/vnd.apple.ist.request.group.v3+json',
            'authorization': f'Bearer {access_token}'
        }

        response = self.session.post(self.ACCESS_REQUEST_URL, json=payload, headers=headers)

        if not response.ok:

            if response.status_code == 409:

                logger.error('request already exists')
                return

            else:
                logger.error(f'could not request access for app_id {app_id} and reason: {response.text}')

        response.raise_for_status()
        return response.json()