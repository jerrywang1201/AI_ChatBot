import json
import logging
import requests
from typing import Any
from functools import wraps
from datetime import datetime, timedelta
from requests.adapters import HTTPAdapter
from requests.exceptions import ContentDecodingError, SSLError, Timeout, ConnectionError

from interlinked.core.config import Config
from interlinked.core.utilities import Utilities
from interlinked.core.singleton import SingletonMeta

logger = logging.getLogger(__name__)


class OakdaleClient(metaclass=SingletonMeta):
	"""
	Interact with oakdale.apple.com's APIs
	"""

	IDMS_APP_ID: str = '152283'
	BASE_URL: str = 'https://oakdale.apple.com'

	token: str
	jwt_token: str = None
	expiration_datetime: datetime = None

	def __init__(self):

		# init session
		self.session = requests.session()
		self.session.mount('https://', HTTPAdapter(pool_connections=15, pool_maxsize=15, max_retries=2))

		self.session.headers['Accept-Encoding'] = 'deflate'
		self.session.headers['Content-Type'] = 'application/json'

	@SingletonMeta.Shared
	def shared(cls) -> 'OakdaleClient':
		return cls(shared=True)

	def requires_valid_token(function):
		"""
		A decorator that ensures the JWT token is up-to-date
		"""

		@wraps(function)
		def wrapper(*args, **kwargs):

			self = args[0]

			# refresh 2 minutes before expiring
			if self.jwt_token is None or datetime.now() >= (self.expiration_datetime - timedelta(minutes=2)):

				self.jwt_token, self.expiration_datetime = self.get_jwt_token()

				if self.jwt_token is None:
					raise Exception(f'Could not get JWT token')

			self.session.headers['Authorization'] = f'Bearer {self.jwt_token}'
			return function(*args, **kwargs)

		return wrapper

	""" APIs """

	@requires_valid_token
	def get_release_sets(self) -> list:
		"""
		Returns ReleaseSet(s) from Oakdale in a list format

		@return (list): a list of release sets
		"""

		response = self.session.get(f'{self.BASE_URL}/@swe/release_sets')

		if not response.ok:
			raise Exception(f'could not get release sets from Oakdale', response.text)

		try:
			response_dict: dict = response.json()
		except:
			raise Exception(f'could not parse release sets JSON from Oakdale', response.text)

		return response_dict.get('release_sets')

	@requires_valid_token
	def get_advisories(self) -> list:
		"""
		Returns advisories from Oakdale in a list format

		@return (list): a list of advisories sets
		"""

		response = self.session.get(f'{self.BASE_URL}/@swe/advisories')

		if not response.ok:
			raise Exception(f'could not get advisories sets from Oakdale', response.text)

		response_dict: dict = response.json()

		return response_dict.get('advisories')

	@requires_valid_token
	def get_components(self) -> list:
		"""
		Returns externally facing component names from Oakdale in a list format
		@return (list): a list of components
		"""

		response = self.session.get(f'{self.BASE_URL}/@swe/components')

		if not response.ok:
			raise Exception(f'could not get components sets from Oakdale', response.text)

		response_dict: dict = response.json()

		return response_dict.get('components')

	def get_platforms_for_id(self, id: int) -> list[dict]:
		"""
		Returns a list of platforms for a given OE Ticket

		@param id(int): The internal Oakdale Ticket ID
		"""

		headers: dict[str, str] = {'accept': 'application/json'}
		cookies: dict[str, str] = {'acack': Utilities.get_apple_connect_token(app_id=self.IDMS_APP_ID)}

		response = requests.get(f'https://oakdale.apple.com/api/item/{id}/platforms', headers=headers, cookies=cookies)

		if not response.ok:
			logger.error(f'could not get platforms ({response.text=})')

		response.raise_for_status()
		return response.json().get('platforms')

	def get_session_token(self, daw_token) -> str:
		"""
		Authenticates and returns a session token
		"""

		headers: dict[str, str] = {'accept': 'application/json'}
		cookies: dict[str, str] = {'acack': Utilities.get_apple_connect_token(app_id=self.IDMS_APP_ID)}
		response = requests.get(f'https://oakdale.apple.com/setup', headers=headers, cookies=cookies, allow_redirects=False)

		if not response.ok:
			logger.error(f'could not authenticate ({response.text=})')

		return response.cookies['session']

	def modify_item(self, changes: dict[str, Any]) -> None:
		"""
		Modifies a Ticket or Radar

		@param id(int): The internal Oakdale Ticket ID
		@param changes(dict): A list of keys/values from `github.pie.apple.com/clopez1/oakdale/blob/development/oakdale/views.py`
		"""

		headers: dict[str, str] = {'accept': 'application/json'}
		daw_token: str = Utilities.get_apple_connect_token(app_id=self.IDMS_APP_ID)

		cookies: dict[str, str] = {

			'acack': daw_token,
			'session': self.get_session_token(daw_token=daw_token),
		}

		response = requests.put(f'https://oakdale.apple.com/item', headers=headers, cookies=cookies,
								 json=changes, allow_redirects=False)

		if not response.ok:
			logger.error(f'could not modify item ({response.text=})')

		response.raise_for_status()
		return response.json()

	""" Authentication """

	def get_jwt_token(self) -> tuple:
		"""
		Generates a JWT token from Oakdale using a given A3 token

		@return (str, datetime): a JWT token, the token's expiration datetime
		"""

		headers: dict = {'Content-Type': 'application/json'}
		response: requests.Response = None

		if Config.current.is_development:

			daw_token: str = Utilities.get_apple_connect_token(app_id=self.IDMS_APP_ID)
			response = requests.request('POST', f'{self.BASE_URL}/login_api', headers=headers,
										cookies={'acack': daw_token}, timeout=10)

		else:

			a3_token: str = self.get_a3_token(other_app_id=self.APP_ID)

			headers['X-Apple-IDMS-A3-Token'] = a3_token
			headers['X-Apple-Client-App-ID'] = str(Config.current.IDMS_APP_ID)

			response = requests.request('POST', f'{hostname}/login_api', headers=headers, timeout=10)

		if not response.ok:
			raise Exception(f'failed to get JWT token due to invalid response ({response.text=}, {hostname=})')

		response_dict: dict = response.json()
		token: str = response_dict.get('token')

		if token is None:
			raise Exception(f'failed to get JWT token ({response_dict=}, {hostname=})')

		return token, datetime.now() + timedelta(hours=5)


if __name__ == '__main__':
	print(OakdaleClient.shared.setup())
	# print(OakdaleClient.shared.modify_item())
	# print(OakdaleClient.shared.get_platforms_for_id(id=681927))
	# print(OakdaleClient.shared.get_advisories())