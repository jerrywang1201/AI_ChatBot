import logging
import requests
from datetime import datetime
from typing import Any, Optional
from atlassian import Confluence
from pydantic import BaseModel, ConfigDict
from urllib.parse import urlparse, unquote_plus

from interlinked.core.config import Config
from interlinked.core.utilities import Utilities
from interlinked.core.singleton import SingletonMeta

logger = logging.getLogger(__name__)


class Page(BaseModel):

	# internal field
	model_config = ConfigDict(arbitrary_types_allowed=True)

	id: str
	url: str
	html: str
	title: str
	space_name: Optional[str] = None
	created_at: Optional[datetime] = None
	last_updated_at: Optional[datetime] = None

	client: 'ConfluenceClient' = None

	@property
	def children(self) -> list['Page']:
		"""
		Returns a list of page
		"""

		children: list[Page] = []
		client: 'ConfluenceClient' = (self.client or ConfluenceClient.shared)

		for page in list(client.get_page_child_by_type(page_id=self.id)):

			page = client.get_page(id=page['id'])

			children.append(page)
			children += page.children

		return children


class ConfluenceClient(Confluence, metaclass=SingletonMeta):

	SD_BASE_URL: str = 'https://confluence.sd.apple.com'
	COMPASS_BASE_URL: str = 'https://compass.scv.apple.com'

	base_url: str = None
	shared: 'ConfluenceClient' = None

	def __init__(self, token: str = None, base_url: str = None, **kwargs):
		"""
		Initalizes `ConfluenceClient`.

		@param token(str): Your Confluence token (from Confluence Settings › Personal Access Tokens)
		@param base_url(str): The Confluence URL (set if your team uses a Confluence other than https://confluence.sd.apple.com)
		@kwargs: any key-value pairs from https://github.com/atlassian-api/atlassian-python-api/blob/master/atlassian/rest_client.py
		"""

		# prefix `base_url` if it doesn't have `https://…`
		if base_url and not base_url.startswith('http'):
			base_url = f'https://{base_url}'

		self.base_url = base_url or self.SD_BASE_URL
		super(ConfluenceClient, self).__init__(
				url=self.base_url,
				token=token or Config.current.SD_CONFLUENCE_ACCESS_TOKEN,
				**kwargs
				)

	@SingletonMeta.Shared
	def shared(cls) -> 'ConfluenceClient':
		return cls(shared=True)

	def get_has_access(self, id: str, dsid: int) -> bool:
		"""
		Checks if a given DSID has access to a Quip document/folder

		@param id(str): the ID of the Quip document/folder
		@param dsid(str): the DSID of the person
		"""

		ancestors: list[dict] = self.get_page_ancestors(id)
		return self.post(f'rest/api/content/{id}/permission/check', data={'operation': 'read', 'subject': {'type': 'user', 'identifier': dsid}})

	def get_page(self, id: str) -> Page:
		"""
		Returns a Confluence `Page`

		@param id(str): the ID of the page (e.g. `0njxOgk8b7xu` or `DevPubs/How+to+Report+a+Bug`)
		@return (Page): a page
		"""

		page: dict[str, Any] = None

		if not str(id).isnumeric():

			url: str = id.split('/display/')[-1].split('?')[0]

			if url.count('/') > 1:
				raise Exception('Invalid URL. Example URL (confluence.sd.apple.com/display/DevPubs/How+to+Report+a+Bug)')

			space, title = unquote_plus(url).split('/')
			page = self.get_page_by_title(space=space, title=title, expand='body.storage,history.createdBy,history.lastUpdated')

		else:
			page = self.get_page_by_id(page_id=id, expand='body.storage,history.createdBy,history.lastUpdated')

		if not page:
			raise Exception('Page not found')

		page['url'] = f'{self.base_url}/pages/viewpage.action?pageId={id}'
		page['html'] = page.get('body', {}).get('storage', {}).get('value')
		page['space_name'] = page.get('_expandable', {}).get('space', '').split('/space/', 1)[-1]

		# add the title to the html to match all other clients
		# TODO: check if header already exists
		page['html'] = f'<h1>{page["title"]}</h1>{page["html"]}'

		history: dict[str, Any] = page.get('history')
		created_at_raw: str = history.get('createdDate')
		last_updated_at_raw: str = history.get('lastUpdated', {}).get('when')
		created_at: datetime = datetime.fromisoformat(created_at_raw) if created_at_raw else None
		last_updated_at: datetime = datetime.fromisoformat(last_updated_at_raw) if last_updated_at_raw else None

		return Page(**page, created_at=created_at, last_updated_at=last_updated_at, client=self)

	def get_page_id_url(self, url: str) -> str:
		"""
		Converts a display Confluence URL to a URL with pageId

		e.g. `confluence.sd.apple.com/display/DevPubs/How+to+Report+a+Bug` ->
			 `confluence.sd.apple.com/pages/viewpage.action?pageId=3341740873`

		@param url(str): A Confluence URL to convert
		"""

		if 'pageId' in url:
			return url

		_url: str = url.split('/display/')[-1].split('?')[0]

		if _url.count('/') > 1:
			raise Exception('Invalid URL. Example URL (confluence.sd.apple.com/display/DevPubs/How+to+Report+a+Bug)')

		space, title = unquote_plus(_url).split('/')
		page: dict[str, Any] = self.get_page_by_title(space=space, title=title)

		if not page:
			raise Exception('Page not found')

		url_parsed: Any = urlparse(url)
		return f'https://{url_parsed.netloc}/pages/viewpage.action?pageId={page["id"]}'


if __name__ == '__main__':
	print(ConfluenceClient.shared.get_page(id='DevPubs/How+to+Report+a+Bug'))
