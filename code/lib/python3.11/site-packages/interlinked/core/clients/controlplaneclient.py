import re
import json
import logging
import requests
from time import sleep
from typing import Any
from requests.adapters import HTTPAdapter, Retry

from interlinked.core.config import Config
from interlinked.core.utilities import Utilities
from interlinked.core.clients.baseaiclient import BaseAIClient, AIModel

logger = logging.getLogger(__name__)


class ControlPlane(BaseAIClient):
	"""
	Client to interact with Control Plane/Arion for fine-tuning
	"""

	BASE_URL: str = 'https://api.afm.aiml.apple.com/controlplane'
	APP_ID: int = 900585

	def __init__(self, daw_token: str = None):

		self.configure_session()
		self.daw_token = daw_token

	def configure_daw_token(self) -> str:
		"""
		[Internal]
		Returns an DAW token (used in local development)
		"""

		self.daw_token = Utilities.get_apple_connect_token(app_id=self.APP_ID)

	@property
	def a3_token(self) -> str:
		"""
		Returns an A3 token
		"""

		if not hasattr(self, '_a3_token'):
			self._a3_token = Utilities.get_a3_token(context=Config.current.AJAX_IDMS_APP_CONTEXT, other_app_id=ControlPlane.APP_ID)

		return self._a3_token

	def configure_session(self) -> None:
		"""
		[Internal]
		Configures the session
		"""

		self.session = requests.session()

		retry: Retry = Retry(total=8, backoff_factor=1, status_forcelist=[502, 503, 504])
		self.session.mount('https://', HTTPAdapter(pool_connections=20, pool_maxsize=20, max_retries=retry))

	def create_project(self, id: str, admin_dsid: int, groups: dict[str, str], quotas: dict[str, int]) -> list[AIModel]:
		"""
		Returns a list of `AIModel` containing models available
		"""

		cookies: dict[str, Any] = None
		headers: dict[str, Any] = {'Content-Type': 'application/json'}

		if Config.current.is_development:

			if self.daw_token is None:
				self.configure_daw_token()

			cookies = {'acack': self.daw_token}

		else:

			headers['X-A3-Person-Id'] = str(Config.current.DSID)
			headers['X-A3-Other-App'] = str(Config.current.IDMS_APP_ID)
			headers['X-A3-Context'] = Config.current.AJAX_IDMS_APP_CONTEXT
			headers['Authorization'] = f'Bearer {Utilities.get_a3_token(context=Config.current.AJAX_IDMS_APP_CONTEXT, other_app_id=ControlPlane.APP_ID, dsid=dsid)}'

		response = self.session.post(f'{self.BASE_URL}/v1/projects', headers=headers, cookies=cookies, json={

			'quotas': quotas,
			'project_id': id,
			'admin_person_id': admin_dsid,
			'project_access_permission_groups': groups,

		}, timeout=15)
		response.raise_for_status()

		return ai_models
