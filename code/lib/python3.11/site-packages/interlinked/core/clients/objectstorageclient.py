import os
import boto3
import hashlib
import logging
import tempfile
import botocore
from io import BytesIO
from boto3.session import Session
from botocore.response import StreamingBody
from botocore.client import Config as BotoConfig

from interlinked.core.config import Config
from interlinked.core.singleton import SingletonMeta

logger = logging.getLogger(__name__)


class CustomBytesIO(BytesIO):

    def cancel(self):
        None


class ObjectStorageClient(metaclass=SingletonMeta):
    """
    Client to store and download files from [Object Storage](https://docs.aci.apple.com/blob_store/index.html)
    """

    # [internal]
    client: Session = None

    # the name of the bucket used when initializing `ObjectStorageClient`
    bucket_name: str = None

    def __init__(self, bucket_name: str = None, endpoint_url: str = None,
                 access_key_id: str = None, secret_access_key: str = None):
        """
        Initializes this client

        @param bucket_name(str): The default bucket/namespace name
        @param endpoint_url(str): e.g. `https://store-123.blobstore.apple.com` (can be found [here](https://docs.aci.apple.com/blob_store/blob_store_endpoints.html))
        @param access_key_id(str): Your Access Key ID
        @param secret_access_key(str): Your Secret Access Key
        """

        bucket_name = bucket_name or Config.current.OBJECT_STORAGE_BUCKET_NAME
        endpoint_url = endpoint_url or Config.current.OBJECT_STORAGE_ENDPOINT_URL
        access_key_id = access_key_id or Config.current.OBJECT_STORAGE_ACCESS_KEY_ID
        secret_access_key = secret_access_key or Config.current.OBJECT_STORAGE_SECRET_ACCESS_KEY

        if not endpoint_url:
            raise Exception('missing endpoint_url')

        # prefix `endpoint_url` if it doesn't have `http://â€¦`
        if endpoint_url and not endpoint_url.startswith('http'):
            endpoint_url = f'http://{endpoint_url}'

        # e.g. `https://store-123.blobstore.apple.com` -> `store-123`
        region_name: str = endpoint_url.split('//')[-1].split('.')[0]

        self.bucket_name = bucket_name
        self.client = boto3.client(service_name='s3', use_ssl=True,
                                   region_name=region_name, endpoint_url=endpoint_url,
                                   aws_access_key_id=access_key_id,
                                   aws_secret_access_key=secret_access_key,
                                   config=BotoConfig(s3={'addressing_style': 'path'}, signature_version='s3v4'))

    @SingletonMeta.Shared
    def shared(cls) -> 'ObjectStorageClient':
        return cls(shared=True)

    def create_bucket(self, name: str) -> None:
        """
        Creates a bucket

        @param name(str): The name of the new bucket
        """

        self.client.create_bucket(Bucket=name)

    def upload(self, key: str, data: bytes, bucket_name: str = None) -> None:
        """
        Uploads a file using a key to a given bucket

        @param key(str): file name (can be a directory name + file name)
        @param data(bytes): The data you'd like to upload (in bytes)
        @param bucket_name(str): (Optional) The name of the bucket. Defaults to the one you used in initialization
        """

        bucket_name = bucket_name or self.bucket_name
        self.client.put_object(Bucket=bucket_name, Key=key, Body=data)

    def download(self, key: str, stream: bool = True, bucket_name: str = None) -> StreamingBody | bytes:
        """
        Downloads a file using a key from a given bucket

        @param key(str): file name (can be a directory name + file name)
        @param stream(bool): Whether to stream the file contents
        @param bucket_name(str): (Optional) The name of the bucket. Defaults to the one you used in initialization
        """

        bucket_name = bucket_name or self.bucket_name
        response = self.client.get_object(Bucket=bucket_name, Key=key)
        body: StreamingBody = response.get('Body')

        if not stream:
            return BytesIO(body.read()).getvalue()

        return body

    def delete(self, key: str, bucket_name: str = None) -> None:
        """
        Deletes a file using a key from a given bucket

        @param key(str): file name (can be a directory name + file name)
        @param bucket_name(str): (Optional) The name of the bucket. Defaults to the one you used in initialization
        """

        bucket_name = bucket_name or self.bucket_name
 
        try:
            self.client.delete_object(Bucket=bucket_name, Key=key)

        except botocore.exceptions.ClientError as error:

            if '404' in str(error.response):

                logger.warning(f'key does not exist. no need to delete anything ({bucket_name=}, {key=})')
                return

            raise error