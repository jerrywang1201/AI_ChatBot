import logging
import requests
from typing import Any
from datetime import datetime, timedelta
from requests.adapters import HTTPAdapter, Retry

from interlinked.core.config import Config
from interlinked.core.singleton import SingletonMeta

logger = logging.getLogger(__name__)


class DisclosureCentralClient(metaclass=SingletonMeta):

	BASE_URL: str = 'https://uat.dc.apple.com/api/public'

	access_token: str = None
	access_token_expires_at: datetime = None

	def __init__(self, *args, **kwargs):
		self.configure_session()

	@SingletonMeta.Shared
	def shared(cls) -> 'DisclosureCentralClient':
		return cls(shared=True)

	def configure_session(self) -> None:
		"""
		[Internal]
		Configures the session
		"""

		self.session = requests.session()

		retry: Retry = Retry(total=8, backoff_factor=1, status_forcelist=[502, 503, 504])
		self.session.mount('https://', HTTPAdapter(pool_connections=20, pool_maxsize=20, max_retries=retry))

	def configure_access_token(self) -> None:
		"""
		Returns an access token
		"""

		headers: dict[str, str] = {'Content-Type': 'application/json', 'cache-control': 'no-cache', 'Accept': 'application/json'}

		response = requests.post(f'{self.BASE_URL}/oauth2-token', headers=headers, json={

			'grant_type': 'password',
			'username': Config.current.DISCLOSURE_CENTRAL_USERNAME,
			'password': Config.current.DISCLOSURE_CENTRAL_PASSWORD,
			'client_id': Config.current.DISCLOSURE_CENTRAL_CLIENT_ID,
			'client_secret': Config.current.DISCLOSURE_CENTRAL_CLIENT_SECRET,
		})

		response.raise_for_status()
		response_dict: dict[str, Any] = response.json()

		self.access_token = response_dict['access_token']
		self.access_token_expires_at = datetime.now() + timedelta(seconds=response_dict['expires_in'])

	def get_projects_for_dsid(self, dsid: int) -> list[dict]:
		"""
		Returns a list of projects a given DSID is disclosed on

		@param dsid(int): the DSID of a person
		"""

		if not self.access_token_expires_at or datetime.now() > self.access_token_expires_at:
			self.configure_access_token()

		headers: dict[str, str] = {'Accept': 'application/vnd.api+json', 'Authorization': f'Bearer {self.access_token}'}

		response = self.session.get(f'{self.BASE_URL}/projects', headers=headers, params={'activeOnly': True, 'user': dsid})

		response.raise_for_status()
		response_dict: dict[str, Any] = response.json()

		return response_dict['data']

	def get_project_names_for_dsid(self, dsid: int) -> list[str]:
		"""
		Returns a list of project names a given DSID is disclosed on

		@param dsid(int): the DSID of a person
		"""
		return [project['attributes']['name'] for project in self.get_projects_for_dsid(dsid=dsid)]
