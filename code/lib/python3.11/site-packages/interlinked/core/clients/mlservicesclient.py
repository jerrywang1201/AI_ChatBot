import logging
from typing import Any
from interlinked.core.utilities import Utilities
from interlinked.core.singleton import SingletonMeta

logger = logging.getLogger(__name__)

try:
	import pandas as pd
	from amlds_time.anomaly_detection.utils.time_series_analysis import TimeSeriesAnalyzer

except ModuleNotFoundError:

	logger.section('installing amlds-time and pandas…')
	Utilities.install_package('pandas')
	Utilities.install_package('amlds-time')

	import pandas as pd
	from amlds_time.anomaly_detection.utils.time_series_analysis import TimeSeriesAnalyzer


class MLServicesClient(metaclass=SingletonMeta):
	"""
	This client allows you to get time series analysis using the AMLDS Time Series Analysis services.

	**[Visit AMLDS ›](https://amlds.apple.com)**
	"""

	@SingletonMeta.Shared
	def shared(cls) -> 'QdrantClient':
		return cls(shared=True)

	def get_time_series_analysis(self, data_frame: pd.DataFrame, metrics: list[str], plot: bool = False,
								 verbose: bool = False) -> dict[str, Any]:
		"""
		Analyzes time series data to detect stability, trends, seasonality, and spikiness.

		**How to use**
		```python
		import pandas as pd
		from interlinked.core.clients.mlservicesclient import MLServicesClient

		# 1️⃣ create a sample DataFrame with time series data
		data: dict[str, list] = {

			'Latency_P50': [25, 30, 27, 28, 35, 26, 24, 29, 31, 27],
			'Latency_P90': [45, 55, 50, 48, 60, 47, 46, 52, 57, 49],
			'unixTime': list(range(1736164800, 1736164800 + 10 * 300, 300)),
			'success_percent': [99.8, 99.9, 100.0, 99.7, 99.8, 99.9, 100.0, 99.8, 99.7, 99.9]}

		# 2️⃣ analyze the time series data, then print
		analysis_results: dict[str, Any] = MLServicesClient.shared.get_time_series_analysis(
			time_series_df=pd.DataFrame(data),
			metrics=['Latency_P50', 'Latency_P90', 'success_percent'],
			plot=False, verbose=True)
			
		print(analysis_results)
		```

		@param data_frame(DataFrame): Time series DataFrame with timestamp data and metrics columns
		@param metrics(list): List of column names in the DataFrame to analyze
		@param plot(bool): Whether to display plots during analysis (default: False)
		@param verbose(bool): Whether to print detailed analysis logs (default: False)
		@return (dict): Dictionary containing analysis results for each metric
		"""
		try:

			analyzer: TimeSeriesAnalyzer = TimeSeriesAnalyzer(time_series_df=data_frame, metrics=metrics, plot=plot, verbose=verbose)
			return analyzer.analyze()

		except Exception as exception:

			logger.error(f'Error during time series analysis: {exception}')
			raise