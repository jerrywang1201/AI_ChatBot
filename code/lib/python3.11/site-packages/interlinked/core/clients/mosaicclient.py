import time
import logging
from typing import Any

from interlinked.core.config import Config
from interlinked.core.utilities import Utilities

logger = logging.getLogger(__name__)


try:
    from apple_mosaic_wrapper.mosaic.mosaic_api import MosaicAPI

except ModuleNotFoundError:

    logger.section('installing apple_mosaic_wrapper')
    Utilities.install_package('apple_mosaic_wrapper')
    from apple_mosaic_wrapper.mosaic.mosaic_api import MosaicAPI


class MosaicClient:
    """
    A client for querying KPIs from Mosaic API
    """

    def __init__(self, client_id: str = None, client_secret: str = None):
        """
        Initializes the Mosaic client

        @param client_id (str): Your Mosaic client ID (optional if in config)
        @param client_secret (str): Your Mosaic client secret (optional if in config)
        """

        self.client_id = client_id or Config.current.MOSAIC_CLIENT_ID
        self.client_secret = client_secret or Config.current.MOSAIC_CLIENT_SECRET
        self.api = MosaicAPI(self.client_id, self.client_secret)

    def fetch_stats(self, host: str, kpi: str, start_time: int, end_time: int, step: int = 60,
                    rate_interval: str = '15s', max_retries: int = 5, workspace: str = "ise-iscloud-vms", namespace: str = ".*", query: str = None) -> list[Any] | None:
        """
        Fetches KPI stats from the Mosaic API

        @param host(str): Hostname or identifier
        @param kpi(str): KPI metric name
        @param start_time(int): Start timestamp (epoch)
        @param end_time(int): End timestamp (epoch)
        @param step(int): Step size (default: 60s)
        @param rate_interval(str): Rate interval (default: "15s")
        @param max_retries(int): Max retries on failure (default: 5)
        @param workspace(str): Workspace under which node is registered while onboarding to mosaic. (e.g., ise-iscloud-vms, aci-kafka)
        @param namespace(str): Namespace is the availability zone where node specifically belongs to. For example: us-east-2-az-02, by default workspace value is: (.*, for all namespaces).
        @param query(str): Custom query for KPI.
        @return (list): List of [timestamp, value] pairs or None
        """
        retries: int = 0

        while retries < max_retries:

            try:
                response = self.api.query_mosaic(host, kpi, step, start_time, end_time, __rate_interval=rate_interval, workspace=workspace, namespace=namespace, query=query)

                if (response.get('status') != 'success' or 'data' not in response or
                    'result' not in response['data'] or len(response['data']['result']) == 0 or
                    'values' not in response['data']['result'][0]):

                    logger.error('Invalid response received from Mosaic API')
                    return None

                return response['data']['result'][0]['values']

            except Exception as exception:

                logger.warning(f'An error occurred. Retrying… (attempt={retries + 1}/{max_retries})', exc_info=True)
                time.sleep(2 ** retries)
                retries += 1

        logger.error('Max retries reached. Fetching data failed.')


if __name__ == '__main__':

    now: int = int(time.time())
    stats = MosaicClient(client_id='…', client_secret='…').fetch_stats(host='hostname', kpi='RAM_used', workspace='ise-iscloud-vms', start_time=now-3600, end_time=now)
    print(stats)
