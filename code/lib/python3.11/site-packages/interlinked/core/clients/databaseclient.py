from typing import Any
from sqlalchemy import text
from sqlmodel import Session
from urllib.parse import quote_plus
from sqlalchemy import create_engine
from contextlib import contextmanager

from interlinked.core.config import Config
from interlinked.core.singleton import SingletonMeta


class DatabaseClient(metaclass=SingletonMeta):
    """
    Client for storing data in PostgreSQL and SQLite
    """

    base: Any = None
    engine: Any = None
    session_local: Any = None

    def __init__(self, in_memory: bool = False):
        """
        Initializes the SQL database

        @param in_memory(bool): (Optional) If set, the entire database will run in memory/RAM and all data
                                stored will only be available until your script/code finishes running
        """

        if Config.current.USE_POSTGRES:

            if Config.current.DATABASE_ENABLE_MTLS:

                connection_params = {
                    'sslmode': 'verify-full',
                    'sslkey': '/certs/application.key',
                    'sslcert': '/certs/application.crt',
                    'sslrootcert': '/certs/trusted-root.pem'
                }

                ssl_params = '&'.join([f"{key}={quote_plus(str(value))}" for key, value in connection_params.items()])

                connection_string = (
                    f'postgresql://{Config.current.DATABASE_USERNAME}@'
                    f'{Config.current.DATABASE_HOSTNAME}:{Config.current.DATABASE_PORT}/'
                    f'{Config.current.DATABASE_NAME}?{ssl_params}'
                )

                self.engine = create_engine(connection_string, pool_size=5, max_overflow=15, pool_timeout=30, pool_recycle=1800, pool_pre_ping=True, connect_args=connection_params)

            else:

                self.engine = create_engine(f'postgresql://{Config.current.DATABASE_USERNAME}:{Config.current.DATABASE_PASSWORD}@{Config.current.DATABASE_HOSTNAME}:{Config.current.DATABASE_PORT}/{Config.current.DATABASE_NAME}',
                                            pool_size=5, max_overflow=15, pool_timeout=30, pool_recycle=1800, pool_pre_ping=True)

        elif in_memory:
            self.engine = create_engine('sqlite://', connect_args={'check_same_thread': False})

        else:

            from pathlib import Path
            self.engine = create_engine(f'sqlite:///{Path.home()}/.interlinked-database.db', connect_args={'check_same_thread': False})

    @SingletonMeta.Shared
    def shared(cls) -> 'DatabaseClient':
        return cls()

    def get_session(self) -> Session:
        """
        Returns a SQL session
        """

        with Session(self.engine) as session:
            yield session

    @contextmanager
    def get_managed_session(self) -> Session:
        """
        Returns a SQL session
        """

        with Session(self.engine) as session:
            yield session

    def check_connection(self) -> None:
        """
        Checks if the database connection is working
        """

        with self.get_managed_session() as session:
            session.exec(text('SELECT 1'))


if __name__ == '__main__':
    DatabaseClient.shared.check_connection()