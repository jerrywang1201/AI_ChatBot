import logging
import requests
from typing import Any

from interlinked.core.config import Config
from interlinked.core.utilities import Utilities

logger = logging.getLogger(__name__)


class RedashClient:
	"""
	[Internal]
	This client allows you to connect to Redash (e.g. seer.apple.com)
	"""

	base_url: str = None

	def __init__(self, api_key: str, base_url: str = 'https://seer.apple.com'):

		# prefix `base_url` if it doesn't have `https://…`
		if base_url and not base_url.startswith('http'):
			base_url = f'https://{base_url}'

		self.base_url = base_url.removesuffix('/')

		self.session = requests.Session()
		self.session.headers = {'Authorization': f'Key {api_key}'}

	def get_dashboard(self, id: int) -> dict:
		"""
		Returns a Redash dashboard
		"""
		response_json: dict = self.session.post(f'{self.base_url}/api/dashboards/{id}').json()
		return response_json

	def get_data_sources(self) -> list[dict]:
		"""
		Returns a list of available data sources
		"""
		response_json: dict = self.session.get(f'{self.base_url}/api/data_sources').json()
		return response_json

	def get_schema(self, data_source_id: str) -> list[dict]:
		"""
		Returns the schema of a database (data source)

		@param data_source_id(str): The ID of the data source
		"""
		response_json: dict = self.session.get(f'{self.base_url}/api/data_sources/{data_source_id}/schema').json()

		if 'schema' not in response_json:
			raise Exception(response_json.get('message'))

		return response_json['schema']

	def get_query_results(self, id: int = None, query: str = None, data_source_id: int = None,
						  parameters: dict[str, Any] = None) -> dict[str, any]:
		"""
		Returns dictionary of results for a given Redash query ID

		@param query_id(int): a Redash query ID
		@param parameters(dict): (Optional) query parameters to pass to Redash
		@return (dict): a dictionary of results (keys are column names, and values are column values)
		"""

		if id is not None:

			parameters = parameters or {}

			# Redash expects all int parameter to be a string
			for key, value in parameters.items():

				if value and isinstance(value, int):
					parameters[key] = str(value)

			# get the results from Redash
			query_results: dict = self.session.post(f'{self.base_url}/api/queries/{id}/results',
													json={'parameters': parameters}).json()
			return query_results.get('query_result', {})

		# get the results from Redash
		response: 'Response' = self.session.post(f'{self.base_url}/api/query_results', json={
			'query': query,
			'data_source_id': data_source_id
		})

		if not response.ok:
			logger.error(response.text)

		response.raise_for_status()
		response_json: dict[str, Any] = response.json()

		if query_result := response_json.get('query_result'):
			return query_result.get('data')

		job_id: str = response_json.get('job').get('id')
		query_result_id: str = None

		while True:

			response: 'Response' = self.session.get(f'{self.base_url}/api/jobs/{job_id}')

			if not response.ok:
				logger.error(response.text)

			response.raise_for_status()
			response_json: dict[str, Any] = response.json()
			job: str = response_json.get('job')

			if job.get('status') == 2:
				continue

			elif job.get('status') == 3:

				query_result_id = job.get('query_result_id')
				break

			elif error := job.get('error'):
				raise Exception(error)

		response: 'Response' = self.session.get(f'{self.base_url}/api/query_results/{query_result_id}')

		if not response.ok:
			logger.error(response.text)

		response.raise_for_status()
		response_json: dict[str, Any] = response.json()

		return response_json.get('query_result').get('data')


if __name__ == '__main__':
	print(RedashClient(api_key='…').get_data_sources)