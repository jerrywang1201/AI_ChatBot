from pydantic import BaseModel
from typing import Any, Optional
from boxsdk import OAuth2, Client

from interlinked.core.config import Config
from interlinked.core.singleton import SingletonMeta


class File(BaseModel):

	id: str
	name: str
	content_: Optional[bytes] = None


class Folder(BaseModel):

	id: str
	name: str
	modified_at: str

	entries: list[dict[str, str|int|bool]]

	client: 'BoxClient' = None

	@property
	def children(self) -> list[Any]:
		"""
		Returns a list of folders/entries
		"""

		children: list[Folder|File] = []

		for child_raw in self.entries:

			if child_raw.get('type') == 'folder':
				children.append(BoxClient.shared.get_folder(id=child_raw.get('id')))

			else:
				children.append(BoxClient.shared.file(child_raw.get('id')).content())

		return children

	@property
	def flattened_files(self) -> list[File]:
		"""
		Returns a list of all files in this folder and nested folders
		"""

		files: list[File] = []

		for child in self.children:

			if isinstance(child, Folder):

				files += child.flattened_files
				continue

			files.append(child)

		return files


class BoxClient(Client, metaclass=SingletonMeta):
	"""
	This client allows you to interact with apple.box.com to read folders, files, and more

	The primary use-case is for reading files and passing them to `AI.learn(from_=â€¦)`
	"""

	client_id: str = None
	client_secret: str = None
	access_token: str = None

	def __init__(self, client_id: str = None, client_secret: str = None,
				 access_token: str = None):

		self.client_id = client_id or Config.current.BOX_CLIENT_ID
		self.client_secret = client_secret or Config.current.BOX_CLIENT_SECRET
		self.access_token = access_token or Config.current.BOX_DEVELOPER_TOKEN

		auth: OAuth2 = OAuth2(client_id=self.client_id, client_secret=self.client_secret,
							  access_token=self.access_token)
		super(BoxClient, self).__init__(auth)

	@SingletonMeta.Shared
	def shared(cls) -> 'BoxClient':
		return cls(shared=True)

	def get_folder(self, id: str) -> Folder:
		"""
		Returns a Box `Folder`

		@param id(str): the ID of the folder (e.g. `9999999999`)
		@return (Folder): a folder
		"""
		folder_raw: dict[str, Any] = self.folder(folder_id=id).get()
		return Folder(id=id, name=folder_raw.name, modified_at=folder_raw.modified_at,
					  entries=[{'id': file.id, 'type': file.type} for file in folder_raw.item_collection.get('entries')])


if __name__ == '__main__':
	print(BoxClient.shared.user().get())