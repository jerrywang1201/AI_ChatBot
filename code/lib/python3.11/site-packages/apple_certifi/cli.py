import os
import sys
from shutil import copy

from apple_certifi import __certifi_version__, __version__, where

usage = """USAGE: {0} [bundle|certs|cp path|version]

Default (with no options) is to print the path to the cacert.pem bundle file.

Optional parameters:
  bundle  : does the same as the default
  certs   : prints the full path of all of the CA files on a single line
  cp path : copy all of the CA files to the specified 'path'
  version : prints the apple-certifi version and exits
""".format(os.path.basename(sys.argv[0]))


def print_error_and_exit(index, extra=None, msg=None):
    """Prints an error message specified by index and exits with status 1"""
    messages = [
        "the script encountered an unknown error (index {})".format(index or extra),
        "path argument must be a directory that exists",
        "the path specified is not writable",
    ]
    try:
        msg = messages[index]
    except IndexError:
        print_error_and_exit(0, index)

    print(usage)
    print("ERROR: {}".format(msg))
    sys.exit(1)


def main():
    """apple-certifi cli"""
    if len(sys.argv) > 1:
        p = os.path.join(os.path.dirname(__file__), "certs")
        ca_files = [os.path.join(p, x) for x in os.listdir(p) if x.endswith(".crt")]

        # print the versions and exit
        if sys.argv[1] in ["-v", "-V", "--version", "version"]:
            print("apple-certifi {} - CA bundle based on certifi {}".format(__version__, __certifi_version__))
            sys.exit()

        # same as the default when no command line options are specified
        if sys.argv[1] == "bundle":
            print(where())

        # simply prints the full path of all the CA certs on a single line
        elif sys.argv[1] == "certs":
            print(" ".join(ca_files))

        # copies all the CA cert files to a directory (must exist and be writable)
        elif sys.argv[1] in ["cp", "copy"] and len(sys.argv) == 3:
            if not os.path.isdir(sys.argv[2]):
                print_error_and_exit(1)
            try:
                for f in ca_files:
                    copy(f, sys.argv[2])
            except IOError:
                print_error_and_exit(2)

        else:
            # unknown or incorrect command line option
            print(usage)

    else:
        # default with no command line options specified
        print(where())
