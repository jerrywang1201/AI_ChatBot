Metadata-Version: 2.4
Name: apple-certifi
Version: 2.3.3
Summary: A Modified certifi Trust Store With Apple Internal CA Certs
Home-page: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi
Author: Matt Williams
Author-email: matthew_l_williams@apple.com
License: Apple Internal
License-File: LICENSE
Dynamic: author
Dynamic: author-email
Dynamic: description
Dynamic: home-page
Dynamic: license
Dynamic: license-file
Dynamic: summary

# apple-certifi

[![loading...](https://badges.pie.apple.com/badges/artifactory?r=pypi-apple&g=~pypi&a=apple-certifi&l=pypi.apple.com)](https://packages.apple.com/pypi/apple-certifi)

## Table of Contents
* [About](#About)
    - [Support](#Support)
    - [CA certificate files included](#CA-certificate-files-included)
* [Installation](#Installation)
* [Usage](#Usage)
    - [Python Code](#Python-Code)
    - [Command Line](#Command-Line)
* [General Notices](#General-Notices)
* [Deprecation Notices](#Deprecation-Notices)
* [Contributing](#Contributing)
    - [Building and publishing to pypi](#Building-and-publishing-to-pypi)
    - [Other dev issues](#Other-dev-issues)
* [TODO](#TODO)
* [Acknowledgements](#Acknowledgements)
* [python-decertifi original acknowledgements](#Original-Acknowledgements)


## About
This python package intercepts imports of certifi at runtime to use an updated
version of the certifi cacerts.pem file that also contains Apple intermediate
and root CA certs.  It also intercepts pip's own embedded (static) copy of
certifi.

It does **NOT** overwrite files included with the certifi or pip packages,
which would require re-patching any time the certifi package is updated. It
also does not require any refactoring or changes to your existing code (save
for any adding `apple-certifi` to any requirements files, e.g. setup.py or
requirements.txt).

This will allow packages such as requests (and tools based on it) to verify
TLS/SSL connections to servers whose cert is signed by an Apple intermediate or
root CA. For more information regarding Apple's internal trust model and CA
hierarchies, please see:
https://certificatemanager.apple.com/#help/caCertificates

The current sources of the Apple CA certificates (pem files) used are:
- https://www.apple.com/certificateauthority/ (only listed Apple Root Certificates)
- https://certificatemanager.apple.com/#help/caCertificates/caCertificatesAdv
- https://kube.apple.com/docs/guides/network-security-and-traffic-control/#certificate-authorities

### Support
This package is largely community supported. For any support questions, please
make use of the following, in order:

1. The Slack [#help-python][slack-help-python] community has a large number of
extremely bright and helpful people that, in all likelihood, may have already
come across and solved the issue you are facing. You can also search that
channel for the term `apple-certifi` to find messages and threads where it was
mentioned.
2. If you were unable to find an answer via Slack, check the
[current and closed issues][issues] on GitHub. If you don't find an existing
issue that answers your question, please feel free to
[create a new issue][new issue].

NOTE: Due to the support model above, directly contacting the package author
or team email listed in the GitHub repository will (usually) result in a
delayed response of days, weeks and sometimes even months (unless it is
associated with a `P0` opened with the IS&T help line).

### CA certificate files included

The source CA files (PEM format) are included as data files in this package.
This permits the use of those files to update Linux OS trusted roots in their
pki store / bundle. More on that in the [Usage](#Usage) section.

## Installation
`apple-certifi` is available on `pypi.apple.com`. Simply install with `pip`:

    pip --trusted-host pypi.apple.com install apple-certifi -i https://pypi.apple.com/simple/

After installation, requests package connections to internal hosts will be able
to be validated successfully. Just add the apple-certifi package to your
package or projects requirements, and once it is installed, that is all you
need to do.

This package includes a "vendorized" version of the wrapt package 1.14.0 to
avoid breaking changes in `wrapt >= v1.14` (see issues [#29][issue29] and
[#31][issue31]), and, to help where pip is doing builds using build isolation
(see [PR #3][pr3] and [PR #5][pr5]). To avoid any package version requirement
conflicts for wrapt, that package is no longer listed as a dependency for
apple-certifi, and only the "vendorized" wrapt is used by this package.

NOTE: If you need to instead use a system cert file `/etc/pki/tls/cert.pem`,
please use the `python-decertifi` package, upon which this package was based,
INSTEAD of `apple-certifi`. Having both of these installed has not been
tested and could produce undesired results.

## Usage

### Python Code
No special usage is needed. Anything that would use the [certifi][2] package
will now use the [apple-certifi][source] packaged CA bundle file instead.

This includes the urllib3 default behavior (since version 1.25), which will
validate certs [if the certifi package is installed][urllib3]. Note: if
the certifi package is **NOT** installed in your project, you can still use
apple-certifi to specify the CA bundle in a similar way (that it does
by default for certifi) by modifying [their example][urllib3]:
```python
import apple_certifi
import urllib3

http = urllib3.PoolManager(
    cert_reqs="CERT_REQUIRED",
    ca_certs=apple_certifi.where()
)

http.request("GET", "https://httpbin.org/")
# (No exception)

http.request("GET", "https://expired.badssl.com")
# urllib3.exceptions.SSLError ...
```

The only known exception to completely overriding all certifi functionality,
is if you need to run it from the command line. I.e. running
`python -m certifi` will fail due to an exception.  Instead, call the
`apple_certifi` module or the `apple-certifi` command line script:
```
$ python -m apple_certifi
/Users/awesome_user/.venv/project/lib/python3.6/site-packages/apple_certifi/cacert.pem
$ apple-certifi
/Users/awesome_user/.venv/project/lib/python3.6/site-packages/apple_certifi/cacert.pem
```
NOTE: see the [Deprecation Notices](#Deprecation-Notices) section regarding
the switch from the `apple_certifi` to the `apple-certifi` command line script.

### Command Line
As mentioned in the [Python code](#Python-code) section above, the package
includes a very basic command line script: `apple-certifi`. Help text can be
output by using `apple-certifi -h` (or any command line option that is not
valid).

The cli can be used for helping other OS command line tools (e.g. curl), and
even for updating Linux OS or other trust stores using the source CA (PEM
format) files.

The default (`apple-certifi` with no command line options) prints out the full
path to the `cacert.pem` bundle file.

`apple-certifi certs` will output the full path of each of the source files on
a single line.

`apple-certifi cp /path/to/destination` will copy each of the files to a
destination directory (destination must exist and be writable).

`apple-certifi version` will print version information and exit.

NOTE: Prior to version 1.1.1, the source files were already included, but each
were named with a `.pem` extension. For reason of compatibility with most
Linux OS distributions' `openssl` package, those files have been renamed to use
the `.crt` extension.

Example `Dockerfile`:
```dockerfile
FROM python:3.7-alpine
# add app user and group first to make sure their IDs get assigned consistently
RUN addgroup -S appgroup && adduser -S -G appgroup appuser
# add basic, persistent package requirements
RUN apk add --no-cache bash curl ca-certificates openssl tini wget
# environment variable for python requests package (not really needed with
# apple-certifi installed...just for reference)
ENV REQUESTS_CA_BUNDLE /etc/ssl/certs/ca-certificates.crt
# environment variable for curl (it should already use this by default)
ENV CURL_CA_BUNDLE /etc/ssl/certs/ca-certificates.crt
# .wgetrc file setting (again, it should use this system path by default)
RUN echo "ca-certificate=/etc/ssl/certs/ca-certificates.crt" >> /home/appuser/.wgetrc
# sane defaults for pip
ENV PIP_NO_CACHE_DIR off
ENV PIP_DISABLE_PIP_VERSION_CHECK on
# add apple-certifi and update Alpine Linux trusted CA store
RUN pip --trusted-host pypi.apple.com \
        install -i https://pypi.apple.com/simple/ apple-certifi \
    && apple-certifi cp /usr/local/share/ca-certificates \
    && update-ca-certificates
```

Example, running curl command with apple-certifi installed:
```shell
export CURL_CA_BUNDLE="$(apple-certifi)"
curl https://some-intenal-host.corp.apple.com/api/v1/data
```

## General Notices

- ~~There is currently a known issue where using `pip install --user` does not
work. The installation does not error out, but apple-certifi will not work
properly. See [issue #12][issue12] for more information.~~ [issue #12][issue12]
has been resolved as of version 2.1.1

- As of May 12, 2020, this package is no longer considered beta. Please
consider upgrading to the latest version (`>=1.1.1`).

- As of version 1.0.4, install issues with non-typical paths for
python libraries (site-packages) and `sys.prefix`, should be resolved. If you
experience an issue installing this package, please use the `-v` option for
pip when installing, and create a new issue on pie GitHub and append the
output to the issue.

- If you have installed any version of this package prior to
version 0.0.6, you are strongly advised to delete any pip cache that would
have been used for the installation, and promptly upgrade to the most recent
version. For macOS that cache would typically be in `~/Library/Cache/pip/`.
For other OS's, the location may vary depending on how you may have installed
it.

- When installed with `python setup.py install` instead of `pip`, the hook that
intercepts `certifi` imports may not work. This is because
[apple-cerifi-init.pth](./apple-certifi-init.pth) needs to be installed in a
folder present in `sys.path`, and the legacy `easy_install` method installs
it relative to the module's egg directory which is typically not in the path.
Use `pip` whenever possible, or set `PYTHONPATH` or update `sys.path` to point
to the directory where `apple-certifi-init.pth` is located as a workaround.

## Deprecation Notices

- ~~As of version 1.1.1 the command line script `apple_certifi` is marked as
  deprecated, and will be removed in a future release. Please update any
  dependencies to use the new `apple-certifi` command line script.~~ As of
  version 2.1.1, the `apple_certifi` script has been removed. Please use the
  `apple-certifi` script instead.

- Support for python2 will be deprecated in a future release.

## Contributing
Pull requests are **always** welcome! All code submitted to this GitHub org
([gns-dc-internal-devops][org]) will be subject to our CI/CD process. This
involves code formatting as well as linting. If your code does not meet the
requirements, then feedback will be given for making corrections, or, your PR
will be re-pointed to a temporary branch and we will make any additional
changes needed before merging and publishing.

apple-certifi [source]

contact: [gns-dc-tools][contact]

NOTE: For support, please reference the [Support](#Support) section above.

As mentioned above, pull requests are always welcome, as is any feedback. If
you find a package that embeds and uses a static copy of a CA bundle file, it
can be [wrapt][1] to point to the apple-certifi bundle. Please feel free to
create a patch or pull request, or just drop us an [email][contact].

### Building and publishing to pypi
For this to install correctly from pypi for py2 or py3, **only sdist is**
**supported**. The reason is due to the requirements for the location of the
`apple-certifi-init.pth` file (directly in site-packages), and how bdist_wheel
hard codes the path to that file at build time. It's also due to how pip
install differs when installing for p2 vs py3. Please reach out to me directly
if you are interested in the technical reasons (challenges) as to why it needs
to be this way.

I cannot stress this enough, **do NOT publish or use bdist_wheel!!!**

I have recently added updates that should resolve prior issues that required
using python2 to do the build, as well as issues with non-typical paths for
python libraries (site-packages) and sys.prefix. I.e. either python2 or
python3 can now be used to build and publish.

Assuming that you have your `~/.pypirc` file set up according to the
[Pie pypi docs], the following exact command line is how the build and
publish should be accomplished (from the root of the repo):

    python setup.py sdist upload -r apple-pypi

### Other dev issues
Using `pip install -e .` is known NOT to work, as that command will not copy
the `apple-certifi-init.pth` to the `/path/to/lib/python{ver}/site-packages/`
directory.

To use the included `test.py` file in the base of this repo, you will need to
ensure to install the `requests` package, and, make sure that you don't have
a shell environment variable `REQUESTS_CA_BUNDLE` set.  You can run
`unset REQUESTS_CA_BUNDLE` to make sure while testing.


## TODO
- Add CI/CD pipeline

## Acknowledgements
This module is a modified mash-up of:
- the [`certifi` package][2]
- & the [`python-decertifi` package][3] on [pypi.apple.com][4]

### Original Acknowledgements
These are the original acknowledgements from the python-decertifi package.
- This module is a modified version of [python-certifi-win32][5]
- This module is inspired by [a patch for python-certifi][6] to implement
  this functionality.
- The method of patching at runtime is built from the [autowrapt module][7]


[org]: https://github.pie.apple.com/gns-dc-internal-devops
[style guide]: https://connectme.apple.com/docs/DOC-646773
[source]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi
[contact]: mailto:gns-dc-tool@group.apple.com,matthew_l_williams@apple.com?subject=python-apple-certifi
[Pie pypi docs]: https://docs.pie.apple.com/artifactory/pypi.html#publishing-internal-packages
[issues]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/issues?q=is%3Aissue
[issue12]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/issues/12
[issue29]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/issues/29
[issue31]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/issues/31
[new issue]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/issues/new/choose
[pr3]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/pull/3
[pr5]: https://github.pie.apple.com/gns-dc-internal-devops/python-apple-certifi/pull/5
[slack-help-python]: https://apple.enterprise.slack.com/archives/CFG0B8TPA
[urllib3]: https://urllib3.readthedocs.io/en/latest/user-guide.html#certificate-verification
[1]: https://github.com/GrahamDumpleton/wrapt
[2]: https://github.com/certifi/python-certifi
[3]: https://github.geo.apple.com/geo-flyover/decertifi
[4]: https://packages.apple.com/pypi/python-decertifi
[5]: https://gitlab.com/alelec/python-certifi-win32
[6]: https://github.com/certifi/python-certifi/pull/54
[7]: https://pypi.python.org/pypi/autowrapt
